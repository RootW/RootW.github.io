I"”<p>â€ƒâ€ƒvhostå­ç³»ç»Ÿåœ¨SPDKä¸­å±äºåº”ç”¨å±‚æˆ–å«åè®®å±‚ï¼Œä¸ºè™šæ‹Ÿæœºæä¾›vhost-blkã€vhost-scsiå’Œvhost-nvmeä¸‰ç§è™šæ‹Ÿè®¾å¤‡ã€‚è¿™é‡Œæˆ‘ä»¬ä»¥vhost-blkä¸ºåˆ†æå¯¹è±¡ï¼Œæ¥è®¨è®ºvhostå­ç³»ç»ŸåŸºæœ¬åŸç†ã€‚</p>

<h3 id="vhostå­ç³»ç»Ÿåˆå§‹åŒ–">vhostå­ç³»ç»Ÿåˆå§‹åŒ–</h3>

<p>â€ƒâ€ƒvhostå­ç³»ç»Ÿçš„æè¿°å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spdk/lib/event/subsystems/vhost/vhost.c:

static struct spdk_subsystem g_spdk_subsystem_vhost = {
    .name = "vhost",
    .init = spdk_vhost_subsystem_init,
    .fini = spdk_vhost_subsystem_fini,
    .config = NULL,
    .write_config_json = spdk_vhost_config_json,
};

static void
spdk_vhost_subsystem_init(void)
{
    int rc = 0;

    rc = spdk_vhost_init();

    spdk_subsystem_init_next(rc);
}
</code></pre></div></div>
<p>â€ƒâ€ƒvhostå­ç³»ç»Ÿåˆå§‹åŒ–æ—¶ï¼Œä¼šä¾æ¬¡å¿è¯•å¯¹vhost-scsiã€vhost-blkå’Œvhost-nvmeè¿›è¡Œåˆå§‹åŒ–ï¼Œå¦‚æœé…ç½®æ–‡ä»¶ä¸­é…ç½®äº†å¯¹åº”ç±»å‹çš„è®¾å¤‡ï¼Œé‚£å°±ä¼šå®Œæˆå¯¹åº”è®¾å¤‡çš„åˆ›å»ºå¹¶åˆå§‹åŒ–ç›‘å¬socketç­‰å¾…qemuå®¢æˆ·ç«¯è¿›è¡Œè¿æ¥ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spdk/lib/vhost/vhost.c:

int
spdk_vhost_init(void)
{
    int ret;

    ...

    ret = spdk_vhost_scsi_controller_construct();
    if (ret != 0) {
        SPDK_ERRLOG("Cannot construct vhost controllers\n");
        return -1;
    }

    ret = spdk_vhost_blk_controller_construct();
    if (ret != 0) {
        SPDK_ERRLOG("Cannot construct vhost block controllers\n");
        return -1;
    }

    ret = spdk_vhost_nvme_controller_construct();
    if (ret != 0) {
        SPDK_ERRLOG("Cannot construct vhost NVMe controllers\n");
        return -1;
    }

    return 0;
}
</code></pre></div></div>

<h3 id="vhost-blkåˆå§‹åŒ–">vhost-blkåˆå§‹åŒ–</h3>

<p>â€ƒâ€ƒvhost-blkåˆå§‹åŒ–æ—¶ä¸»è¦å®Œæˆäº†ä¸¤éƒ¨åˆ†å·¥ä½œï¼šä¸€æ˜¯vhostè®¾å¤‡é€šç”¨éƒ¨åˆ†ï¼Œå³å»ºç«‹ç›‘å¬socketå¹¶æ‹‰èµ·ç›‘å¬çº¿ç¨‹ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ï¼›å¦ä¸€æ–¹é¢æ˜¯vhost-blkç‰¹æœ‰çš„åˆå§‹åŒ–åŠ¨ä½œï¼Œå³æ‰“å¼€bdevè®¾å¤‡å¹¶å»ºç«‹è”ç³»ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spdk/lib/vhost/vhost_blk.c:

int
spdk_vhost_blk_construct(const char *name, const char *cpumask, const char *dev_name, bool readonly)
{
    struct spdk_vhost_blk_dev *bvdev = NULL;
    struct spdk_bdev *bdev;
    int ret = 0;

    spdk_vhost_lock();

    /* é¦–å…ˆé€šè¿‡bdevåç§°æŸ¥æ‰¾å¯¹åº”çš„bdevå¯¹è±¡ï¼›bdevå­ç³»ç»Ÿåœ¨vhostå­ç³»ç»Ÿä¹‹å‰å…ˆå®Œæˆåˆå§‹åŒ–ï¼Œæ­£å¸¸æƒ…å†µä¸‹è¿™é‡Œèƒ½æ‰¾åˆ°å¯¹åº”çš„bdev */
    bdev = spdk_bdev_get_by_name(dev_name);
    ...

    bvdev = spdk_dma_zmalloc(sizeof(*bvdev), SPDK_CACHE_LINE_SIZE, NULL);
    ...

    /* æ‰“å¼€å¯¹åº”çš„bdevï¼Œå¹¶å°†å¥æŸ„è®°å½•åˆ°bvdev-&gt;bdev_descä¸­ */
    ret = spdk_bdev_open(bdev, true, bdev_remove_cb, bvdev, &amp;bvdev-&gt;bdev_desc);
    ...

    bvdev-&gt;bdev = bdev;
    bvdev-&gt;readonly = readonly;

    /* å®Œæˆvhostè®¾å¤‡é€šç”¨éƒ¨åˆ†åŠŸèƒ½çš„åˆå§‹åŒ–ï¼Œå¹¶å°†è¯¥vhostè®¾å¤‡çš„backendæ“ä½œé›†åˆè®¾ä¸ºvhost_blk_device_backendï¼›
        è¯´æ˜ï¼šä¸åŒçš„vhostç±»å‹å®ç°äº†ä¸åŒçš„backendï¼Œä»¥å®Œæˆä¸åŒç±»å‹ç‰¹å®šçš„ä¸€äº›æ“ä½œè¿‡ç¨‹ã€‚æˆ‘ä»¬åœ¨åç»­åˆ†æå®¢æˆ·ç«¯è¿æ¥
        æ“ä½œæ—¶ä¼šæ·±å…¥åˆ†æbackendçš„å®ç° */
    ret = spdk_vhost_dev_register(&amp;bvdev-&gt;vdev, name, cpumask, &amp;vhost_blk_device_backend);
    ...

    spdk_vhost_unlock();
    return ret;
}
</code></pre></div></div>

<p>â€ƒâ€ƒvhostè®¾å¤‡åˆå§‹åŒ–ä¸»è¦æä¾›äº†ä¸€ä¸ªå¯ä¾›å®¢æˆ·ç«¯(å¦‚qemu)è¿æ¥çš„socketï¼Œå¹¶éµå¾ªvhoståè®®å®ç°è¿æ¥æœåŠ¡ï¼Œè¿™éƒ¨åˆ†åŠŸèƒ½ä¹Ÿæ˜¯DPDKä¸­å·²å®ç°çš„åŠŸèƒ½ï¼ŒSPDKç›´æ¥å€Ÿç”¨äº†ç›¸å…³ä»£ç ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spdk/lib/vhost/vhost.c:

int
spdk_vhost_dev_register(struct spdk_vhost_dev *vdev, const char *name, const char *mask_str,
                                            const struct spdk_vhost_dev_backend *backend)
{
    char path[PATH_MAX];
    struct stat file_stat;
    struct spdk_cpuset *cpumask;
    int rc;


    /* å°†é…ç½®æ–‡ä»¶ä¸­è¯»å–çš„mask_strè½¬æ¢æˆä½å›¾è®°å½•åˆ°cpumaskä¸­ï¼Œä»£è¡¨è¯¥vhostè®¾å¤‡å¯ä»¥ç»‘å®šçš„CPUæ ¸èŒƒå›´ */
    cpumask = spdk_cpuset_alloc();
    ...
    if (spdk_vhost_parse_core_mask(mask_str, cpumask) != 0) {
    ...
    }
    ...

    /* ç”Ÿæˆsocketæ–‡ä»¶è·¯å¾„åï¼Œè§„åˆ™æ˜¯è®¾å¤‡è·¯å¾„å(vhostå‘½ä»¤å¯åŠ¨æ—¶-Så‚æ•°æŒ‡å®š)åŠ ä¸Švhostå¯¹è±¡åç§°ï¼Œ
        ä¾‹å¦‚ â€œ/var/tmp/vhost.2â€ */
    if (snprintf(path, sizeof(path), "%s%s", dev_dirname, name) &gt;= (int)sizeof(path)) {
        ...
    }
    ...

    /* ç”Ÿæˆsocketç›‘å¬å¥æŸ„ */
    if (rte_vhost_driver_register(path, 0) != 0) {
        ...
    }
    if (rte_vhost_driver_set_features(path, backend-&gt;virtio_features) ||
            rte_vhost_driver_disable_features(path, backend-&gt;disabled_features)) {
        ...
    }

    /* æ³¨å†Œsocketè¿æ¥å»ºç«‹åçš„æ¶ˆæ¯å¤„ç†notify_opå›è°ƒ */
    if (rte_vhost_driver_callback_register(path, &amp;g_spdk_vhost_ops) != 0) {
        ...
    }

    /* æ‹‰èµ·ä¸€ä¸ªç›‘å¬çº¿ç¨‹ï¼Œå¼€å§‹ç­‰å¾…å®¢æˆ·è¿æ¥è¯·æ±‚ */
    if (spdk_call_unaffinitized(_start_rte_driver, path) == NULL) {
        ...
    }

    vdev-&gt;name = strdup(name);
    vdev-&gt;path = strdup(path);
    vdev-&gt;id = ctrlr_num++;
    vdev-&gt;vid = -1; /* ä»£è¡¨å®¢æˆ·ç«¯è¿æ¥å¯¹è±¡ï¼Œåœ¨å®¢æˆ·ç«¯è¿æ¥è¿‡ç¨‹ä¸­ç”Ÿæˆ */
    vdev-&gt;lcore = -1; /* ä»£è¡¨å½“å‰vhostè®¾å¤‡ç»‘å®šåˆ°å“ªä¸ªæ ¸ä¸Šè¿è¡Œï¼Œä¹Ÿæ˜¯åœ¨å®¢æˆ·ç«¯è¿æ¥åè¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­ç”Ÿæˆ */
    vdev-&gt;cpumask = cpumask;
    vdev-&gt;registered = true;
    vdev-&gt;backend = backend;

    ...

    TAILQ_INSERT_TAIL(&amp;g_spdk_vhost_devices, vdev, tailq);

    return 0;
}
</code></pre></div></div>

<p>â€ƒâ€ƒ_start_rte_driverä¼šæ‹‰èµ·ä¸€ä¸ªç›‘å¬çº¿ç¨‹æ‰§è¡Œfdset_event_dispatchå‡½æ•°ï¼Œè¯¥å‡½æ•°ç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ã€‚å½“qemuå‘socketå‘èµ·è¿æ¥è¯·æ±‚æ—¶ï¼Œç›‘å¬çº¿ç¨‹æ”¶åˆ°è¯¥è¯·æ±‚å¹¶è°ƒç”¨vhost_user_server_new_connectionå»ºç«‹ä¸€ä¸ªæ–°çš„è¿æ¥ï¼Œç„¶ååœ¨æ–°çš„è¿æ¥ä¸Šç­‰å¾…å®¢æˆ·ç«¯å‘æ¶ˆæ¯ã€‚æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œç›‘å¬çº¿ç¨‹ä¼šè°ƒç”¨vhost_user_read_cbå‡½æ•°å¤„ç†æ¶ˆæ¯ã€‚æ¶ˆæ¯çš„å¤„ç†ä»£è¡¨äº†vhoståè®®çš„åŸºæœ¬åŸç†ï¼Œæˆ‘ä»¬å°†åœ¨åç»­ç‹¬ç«‹çš„åšæ–‡ä»‹ç»ã€‚</p>

<p><br />
è½¬è½½è¯·æ³¨æ˜ï¼š<a href="https://rootw.github.io">å´æ–Œçš„åšå®¢</a> Â» <a href="https://rootw.github.io/2018/05/SPDK-subsys-vhost/">ã€SPDKã€‘å…­ã€vhostå­ç³»ç»Ÿ</a></p>
:ET