I"à€<p>â€ƒâ€ƒæœ¬ç¯‡è®¨è®ºè¿›ç¨‹æ›¿æ¢(exec)ï¼Œè®¡ç®—å­ç³»ç»Ÿç›¸å…³å†…å®¹ç›®å½•<a href="https://rootw.github.io/2017/02/è®¡ç®—å­ç³»ç»Ÿ/">ç‚¹æ­¤è¿›å…¥</a>ã€‚</p>

<h3 id="ä»€ä¹ˆæ˜¯è¿›ç¨‹æ›¿æ¢ä¸ºä»€ä¹ˆéœ€è¦å®ƒ">ä»€ä¹ˆæ˜¯è¿›ç¨‹æ›¿æ¢ï¼Ÿä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ</h3>

<p>â€ƒâ€ƒè¿›ç¨‹æ›¿æ¢æ˜¯ç”¨æ–°çš„ä»£ç å’Œæ•°æ®æ›¿æ¢å½“å‰è¿›ç¨‹å·²æœ‰ä»£ç å’Œæ•°æ®ï¼Œä»è€Œå¼€å§‹æ‰§è¡Œæ–°çš„ä¸šåŠ¡é€»è¾‘ã€‚</p>

<p>â€ƒâ€ƒé€šè¿‡forkåˆ›å»ºå‡ºæ¥çš„è¿›ç¨‹æ˜¯ç»§æ‰¿çˆ¶è¿›ç¨‹çš„ä»£ç å’Œæ•°æ®ï¼Œå¦‚æœæƒ³è¦è¿›ç¨‹æ‰§è¡Œä¸€äº›æ–°çš„ä»»åŠ¡ï¼Œé‚£å°±å¾—ä»ç£ç›˜ç¨‹åºä¸­åŠ è½½æ–°çš„ä»£ç å’Œæ•°æ®å¹¶æ›¿æ¢å½“å‰è¿›ç¨‹å·²æœ‰çš„ä»£ç å’Œæ•°æ®ã€‚</p>

<h3 id="å¦‚ä½•å®ç°è¿›ç¨‹æ›¿æ¢">å¦‚ä½•å®ç°è¿›ç¨‹æ›¿æ¢ï¼Ÿ</h3>

<h4 id="1-execç”¨æˆ·æ€ç¤ºä¾‹ä»£ç "><strong>1. execç”¨æˆ·æ€ç¤ºä¾‹ä»£ç </strong></h4>

<p>â€ƒâ€ƒæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ç”¨æˆ·æ€ç¨‹åºä¸­æ˜¯å¦‚ä½•å®ç°æ›¿æ¢çš„ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>exec_test.c:

#include &lt;stdio.h&gt;  
#include &lt;unistd.h&gt;  

/*ç¤ºä¾‹å‡½æ•°forkä¸€ä¸ªæ–°è¿›ç¨‹å¹¶åœ¨å…¶ä¸­æ‰§è¡Œpså‘½ä»¤*/
int main()  
{
    /*æ„é€ å‘½ä»¤è¡Œå‚æ•°ps_argvå’Œç¯å¢ƒå˜é‡ps_envp*/
    char *const ps_argv[] ={"ps", "-o", "pid,ppid,pgrp,session,tpgid,comm", NULL};  
    char *const ps_envp[] ={"PATH=/bin:/usr/bin", "TERM=console", NULL};

    if(fork()==0){ 
        /*æ‰§è¡Œexecveç³»ç»Ÿè°ƒç”¨ï¼Œç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºå¯æ‰§è¡Œæ–‡ä»¶çš„ä½ç½®ï¼Œç¬¬äºŒä¸ªè¡¨ç¤ºå‘½ä»¤è¡Œå‚æ•°ï¼Œç¬¬ä¸‰ä¸ªè¡¨ç¤ºç¯å¢ƒå˜é‡ã€‚
          è¿™é‡Œæ³¨æ„execæ˜¯ä¸€ä¸ªå‡½æ•°ç°‡ï¼Œå…¶æœ‰6ç§ç±»ä¼¼çš„ç³»ç»Ÿè°ƒç”¨ï¼š
          (1)6ç§è°ƒç”¨çš„å‰4ä¸ªå­—ç¬¦ç›¸åŒï¼Œå‡æ˜¯exec;
          (2)ç¬¬5ä½æœ‰vå’Œlä¸¤ç§ï¼Œvè¡¨ç¤ºå‘é‡è¡¨ç¤ºæ³•ï¼Œlè¡¨ç¤ºé€ä¸ªåˆ—ä¸¾;
          (3)ç¬¬6ä½æœ‰eå’Œpä¸¤ç§ï¼Œeè¡¨ç¤ºå¸¦ç¯å¢ƒå˜é‡ï¼Œpè¡¨ç¤ºå¯æ‰§è¡Œç¨‹åºä»¥æ–‡ä»¶åæ–¹å¼æŸ¥æ‰¾ï¼Œè€Œä¸æ˜¯è·¯å¾„æŸ¥æ‰¾;*/
        if(execve("/bin/ps", ps_argv, ps_envp) &lt; 0)  {  
            perror("execve error!");  
            return -1 ;  
        }  
    }  
    return 0 ;  
}  
</code></pre></div></div>

<h4 id="2-elfå¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼è§£æ"><strong>2. ELFå¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼è§£æ</strong></h4>

<p>â€ƒâ€ƒé€šè¿‡ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬çœ‹åˆ°åº”ç”¨ç¨‹åºé€šè¿‡è°ƒç”¨execveç³»ç»Ÿè°ƒç”¨å®ç°æ‰§è¡Œç¨‹åºçš„æ›¿æ¢ã€‚Linuxå¹³å°ä¸Šä¸»æµçš„å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼æ˜¯ELF(Executable and Linkable Formatï¼Œç±»ä¼¼Windowså¹³å°ä¸Šçš„exeæ–‡ä»¶æ ¼å¼)ï¼Œå¦‚æœæƒ³æ·±å…¥åˆ†æexecveè°ƒç”¨åŠŸèƒ½ï¼Œé‚£æˆ‘ä»¬å°±å¾—äº†è§£ELFæ–‡ä»¶æ ¼å¼ï¼Œè¯¦ç»†è§„èŒƒè¯´æ˜<a href="http://www.skyfree.org/linux/references/ELF_Format.pdf">ç‚¹æ­¤</a>è¿›å…¥ã€‚</p>

<h5 id="21-ç¤ºä¾‹ç¨‹åº"><strong>2.1. ç¤ºä¾‹ç¨‹åº</strong></h5>

<p>â€ƒâ€ƒçœŸæ­£ç†è§£ELFæ ¼å¼åï¼Œæˆ‘ä»¬èƒ½å¤Ÿå°†Cè¯­è¨€æºæ–‡ä»¶ä¸ELFäºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œå¯¹åº”ï¼Œè¿™æ ·å¯ä»¥æå‡å¯¹åº•å±‚ç³»ç»Ÿé—®é¢˜çš„å®šä½èƒ½åŠ›ã€‚å› æ­¤ä¸ºæ–¹ä¾¿å¤§å®¶å…¥é—¨ï¼Œè¿™é‡Œä»¥ä¸€ä¸ªç®€å•çš„Cè¯­è¨€ç¨‹åºä¸ºä¾‹ï¼Œæ¥é€ä¸€å¯¹åº”ELFä¸­çš„å„éƒ¨åˆ†ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~/tmp_analyze_elf/main.c:

#include &lt;stdio.h&gt;

void say_hello(char *who)
{
    printf("hello, %s!\n", who);
}

char *my_name = "wb";

int main()
{
    say_hello(my_name);
    return 0;
}
</code></pre></div></div>

<p>â€ƒâ€ƒæˆ‘ä»¬å°†å…¶ç¼–è¯‘ç”Ÿæˆåä¸ºappçš„å¯æ‰§è¡Œç¨‹åºå¹¶è¿è¡Œï¼š</p>

<blockquote>
  <p>linux-XqAfQZ:~/tmp_analyze_elf # <strong>gcc -o</strong> app main.c<br />
linux-XqAfQZ:~/tmp_analyze_elf # <strong>./app</strong><br />
hello, wb!</p>
</blockquote>

<h5 id="22-elfæ•´ä½“å¸ƒå±€"><strong>2.2. ELFæ•´ä½“å¸ƒå±€</strong></h5>

<p>â€ƒâ€ƒELFæ ¼å¼å¯ä»¥è¡¨è¾¾ä¸‰ç§ç±»å‹çš„äºŒè¿›åˆ¶å¯¹è±¡æ–‡ä»¶(object files)ï¼šå¯é‡å®šä½æ–‡ä»¶(relocatable fileï¼Œå°±æ˜¯å¤§å®¶å¹³å¸¸è§åˆ°çš„.oæ–‡ä»¶)ã€å¯æ‰§è¡Œæ–‡ä»¶(executable file, ä¾‹ä¸Šè¿°ç¤ºä¾‹ä»£ç ç”Ÿæˆçš„appæ–‡ä»¶)ã€å…±äº«åº“æ–‡ä»¶(shared object filesï¼Œå°±æ˜¯.soæ–‡ä»¶ï¼Œç”¨æ¥åšåŠ¨æ€é“¾æ¥)ã€‚å¯é‡å®šä½æ–‡ä»¶ç”¨åœ¨ç¼–è¯‘å’Œé“¾æ¥é˜¶æ®µï¼›å¯æ‰§è¡Œæ–‡ä»¶ç”¨åœ¨ç¨‹åºè¿è¡Œé˜¶æ®µï¼›å…±äº«åº“åˆ™åŒæ—¶ç”¨åœ¨ç¼–è¯‘é“¾æ¥å’Œè¿è¡Œé˜¶æ®µã€‚åœ¨ä¸åŒé˜¶æ®µï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸åŒè§†è§’æ¥ç†è§£ELFæ–‡ä»¶ï¼Œæ•´ä½“å¸ƒå±€å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>

<div align="center">
<img src="/images/posts/i440fx/process2_1.jpg" height="300" width="450" />  
</div>

<p>â€ƒâ€ƒä»ä¸Šå›¾å¯è§ï¼ŒELFæ ¼å¼æ–‡ä»¶æ•´ä½“å¯åˆ†ä¸ºå››å¤§éƒ¨åˆ†ï¼š</p>
<blockquote>
  <ul>
    <li>ELF Header, ELFå¤´éƒ¨ï¼Œå®šä¹‰å…¨å±€æ€§ä¿¡æ¯ï¼›</li>
    <li>Program Header Tableï¼Œ æè¿°æ®µ(Segment)ä¿¡æ¯çš„æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ å¯¹åº”ä¸€ä¸ªæ®µï¼›é€šå¸¸åŒ…å«åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œå¯é‡å®šæ–‡ä»¶ä¸­å¯é€‰(é€šå¸¸ä¸åŒ…å«)ï¼›</li>
    <li>Segment and Sectionï¼Œæ®µ(Segment)ç”±è‹¥å¹²åŒº(Section)ç»„æˆï¼›æ®µåœ¨è¿è¡Œæ—¶è¢«åŠ è½½åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ä¸­ï¼ŒåŒ…å«åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼›åŒºæ˜¯æ®µçš„ç»„æˆå•å…ƒï¼ŒåŒ…å«åœ¨å¯æ‰§è¡Œæ–‡ä»¶å’Œå¯é‡å®šä½æ–‡ä»¶ä¸­ï¼›</li>
    <li>Section Header Tableï¼Œæè¿°åŒº(Section)ä¿¡æ¯çš„æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ å¯¹åº”ä¸€ä¸ªåŒºï¼›é€šå¸¸åŒ…å«åœ¨å¯é‡å®šä½æ–‡ä»¶ä¸­ï¼Œå¯æ‰§è¡Œæ–‡ä»¶ä¸­ä¸ºå¯é€‰(é€šå¸¸åŒ…å«)ï¼›</li>
  </ul>
</blockquote>

<h5 id="23-elf-headerå®ä¾‹è§£æ"><strong>2.3. ELF Headerå®ä¾‹è§£æ</strong></h5>

<p>â€ƒâ€ƒELFè§„èŒƒä¸­å¯¹ELF Headerä¸­å„å­—æ®µçš„å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<div align="center">
<img src="/images/posts/i440fx/process2_2.jpg" height="300" width="350" />  
</div>

<p>â€ƒâ€ƒæ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡readelf -hå‘½ä»¤æ¥çœ‹çœ‹ç¤ºä¾‹ç¨‹åºappä¸­çš„ELF Headerå†…å®¹ï¼Œæ˜¾ç¤ºç»“æœå¦‚ä¸‹å›¾ï¼š</p>

<div align="center">
<img src="/images/posts/i440fx/elf-header.jpg" height="380" width="600" />  
</div>

<blockquote>
  <ul>
    <li><strong>e_ident</strong>å«å‰16ä¸ªå­—èŠ‚ï¼Œåˆå¯ç»†åˆ†æˆclassã€dataã€versionç­‰å­—æ®µï¼Œå…·ä½“å«ä¹‰ä¸ç”¨å¤ªå…³å¿ƒï¼Œåªéœ€çŸ¥é“å‰4ä¸ªå­—èŠ‚ç‚¹åŒ…å«â€ELFâ€å…³é”®å­—ï¼Œè¿™æ ·å¯ä»¥åˆ¤æ–­å½“å‰æ–‡ä»¶æ˜¯å¦æ˜¯ELFæ ¼å¼ï¼›</li>
    <li><strong>e_type</strong>è¡¨ç¤ºå…·ä½“ELFç±»å‹ï¼Œå¯é‡å®šä½æ–‡ä»¶/å¯æ‰§è¡Œæ–‡ä»¶/å…±äº«åº“æ–‡ä»¶ï¼Œæ˜¾ç„¶è¿™é‡Œæ˜¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼›<strong>e_machine</strong>è¡¨ç¤ºæ‰§è¡Œçš„æœºå™¨å¹³å°ï¼Œè¿™é‡Œæ˜¯x86_64ï¼›</li>
    <li><strong>e_version</strong>è¡¨ç¤ºæ–‡ä»¶ç‰ˆæœ¬å·ï¼Œè¿™é‡Œçš„1è¡¨ç¤ºåˆå§‹ç‰ˆæœ¬å·ï¼›</li>
    <li><strong>e_entry</strong>å¯¹åº”â€Entry point addressâ€ï¼Œç¨‹åºå…¥å£å‡½æ•°åœ°å€ï¼Œé€šè¿‡è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´åœ°å€(0x400440)è¡¨è¾¾ï¼›</li>
    <li><strong>e_phoff</strong>å¯¹åº”â€œStart of program headersâ€ï¼Œè¡¨ç¤ºprogram header tableåœ¨æ–‡ä»¶å†…çš„åç§»ä½ç½®ï¼Œè¿™é‡Œæ˜¯ä»ç¬¬64å·å­—èŠ‚(å‡è®¾åˆå§‹ä¸º0å·å­—èŠ‚)å¼€å§‹ï¼›</li>
    <li><strong>e_shoff</strong>å¯¹åº”â€Start of section headersâ€ï¼Œè¡¨ç¤ºsection header tableåœ¨æ–‡ä»¶å†…çš„åç§»ä½ç½®ï¼Œè¿™é‡Œæ˜¯ä»ç¬¬4472å·å­—èŠ‚å¼€å§‹ï¼Œé è¿‘æ–‡ä»¶å°¾éƒ¨ï¼›</li>
    <li><strong>e_flags</strong>è¡¨ç¤ºä¸CPUå¤„ç†å™¨æ¶æ„ç›¸å…³çš„ä¿¡æ¯ï¼Œè¿™é‡Œä¸ºé›¶ï¼›<strong>e_ehsize</strong>å¯¹åº”â€Size of this headerâ€ï¼Œè¡¨ç¤ºæœ¬ELF headerè‡ªèº«çš„é•¿åº¦ï¼Œè¿™é‡Œä¸º64ä¸ªå­—èŠ‚ï¼Œå›çœ‹å‰é¢çš„e_phoffä¸º64ï¼Œè¯´æ˜ELF headeråç´§è·Ÿç€program header tableï¼›</li>
    <li><strong>e_phentsize</strong>å¯¹åº”â€œSize of program headersâ€ï¼Œè¡¨ç¤ºprogram header tableä¸­æ¯ä¸ªå…ƒç´ çš„å¤§å°ï¼Œè¿™é‡Œä¸º56ä¸ªå­—èŠ‚ï¼›</li>
    <li><strong>e_phnum</strong>å¯¹åº”â€Number of program headersâ€ï¼Œè¡¨ç¤ºprogram header tableä¸­å…ƒç´ ä¸ªæ•°ï¼Œè¿™é‡Œä¸º9ä¸ªï¼›</li>
    <li><strong>e_shentsize</strong>å¯¹åº”â€Size of section headersâ€ï¼Œè¡¨ç¤ºsection header tableä¸­æ¯ä¸ªå…ƒç´ çš„å¤§å°ï¼Œè¿™é‡Œä¸º64ä¸ªå­—èŠ‚ï¼›</li>
    <li><strong>e_shnum</strong>å¯¹åº”â€Number of section headersâ€ï¼Œè¡¨ç¤ºsection header tableä¸­å…ƒç´ çš„ä¸ªæ•°ï¼Œè¿™é‡Œä¸º30ä¸ªï¼›</li>
    <li>æœ€åï¼Œ <strong>e_shstrndx</strong>å¯¹åº”â€Section header string table indexâ€ï¼Œè¡¨ç¤ºæè¿°å„sectionå­—ç¬¦åç§°çš„string tableåœ¨section header tableä¸­çš„ä¸‹æ ‡ï¼Œè¯¦è§åæ–‡å¯¹string tableçš„ä»‹ç»ã€‚</li>
  </ul>
</blockquote>

<h5 id="24-program-header-tableå®ä¾‹è§£æ"><strong>2.4. Program Header Tableå®ä¾‹è§£æ</strong></h5>

<p>â€ƒâ€ƒProgram Header Tableæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ å«Program Headerï¼Œè§„èŒƒå¯¹å…¶ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š</p>

<div align="center">
<img src="/images/posts/i440fx/process2_3.jpg" height="200" width="300" />  
</div>

<p>â€ƒâ€ƒåŒæ ·æˆ‘ä»¬ç”¨readelf -lå‘½ä»¤æŸ¥çœ‹ç¤ºä¾‹ç¨‹åºçš„program header tableï¼š</p>

<div align="center">
<img src="/images/posts/i440fx/elf-program-header1.jpg" height="500" width="600" />  
</div>

<p>â€ƒâ€ƒä¸Šå›¾æˆªå–äº†readelfå‘½ä»¤è¿”å›çš„ä¸ŠåŠéƒ¨ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹ä¸‹å‰é¢å‡ é¡¹ï¼š</p>

<blockquote>
  <ul>
    <li><strong>PHDR</strong>ï¼Œæ­¤ç±»å‹headerå…ƒç´ æè¿°äº†program header tableè‡ªèº«çš„ä¿¡æ¯ã€‚ä»è¿™é‡Œçš„å†…å®¹çœ‹å‡ºï¼Œç¤ºä¾‹ç¨‹åºçš„program header tableåœ¨æ–‡ä»¶ä¸­çš„åç§»(Offset)ä¸º0x40ï¼Œå³64å·å­—èŠ‚å¤„ï¼›è¯¥æ®µæ˜ å°„åˆ°è¿›ç¨‹ç©ºé—´çš„è™šæ‹Ÿåœ°å€(VirtAddr)ä¸º0x400040ï¼›PhysAddræš‚æ—¶ä¸ç”¨ï¼Œå…¶ä¿æŒå’ŒVirtAddrä¸€è‡´ï¼›è¯¥æ®µå ç”¨çš„æ–‡ä»¶å¤§å°FileSizä¸º00x1f8ï¼›è¿è¡Œæ—¶å ç”¨è¿›ç¨‹ç©ºé—´å†…å­˜å¤§å°MemSizä¹Ÿä¸º0x1f8ï¼›Flagsæ ‡è®°è¡¨ç¤ºè¯¥æ®µçš„è¯»å†™æƒé™ï¼Œè¿™é‡Œâ€R Eâ€è¡¨ç¤ºå¯è¯»å¯æ‰§è¡Œï¼Œè¯´æ˜æœ¬æ®µå±äºä»£ç æ®µï¼›Alignå¯¹é½ä¸º8ï¼Œè¡¨æ˜æœ¬æ®µæŒ‰8å­—èŠ‚å¯¹é½ã€‚</li>
    <li><strong>INTERP</strong>ï¼Œæ­¤ç±»å‹headerå…ƒç´ æè¿°äº†ä¸€ä¸ªç‰¹æ®Šå†…å­˜æ®µï¼Œè¯¥æ®µå†…å­˜è®°å½•äº†åŠ¨æ€åŠ è½½è§£æå™¨çš„è®¿é—®è·¯å¾„å­—ç¬¦ä¸²ã€‚ç¤ºä¾‹ç¨‹åºä¸­ï¼Œè¯¥æ®µå†…å­˜ä½äºæ–‡ä»¶åç§»0x238å¤„ï¼Œå³ç´§è·Ÿprogram header tableï¼›æ˜ å°„çš„è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´åœ°å€ä¸º0x400238ï¼›æ–‡ä»¶é•¿åº¦å’Œå†…å­˜æ˜ å°„é•¿åº¦å‡ä¸º0x1cï¼Œå³28ä¸ªå­—ç¬¦ï¼Œå…·ä½“å†…å®¹ä¸ºâ€/lib64/ld-linux-x86-64.so.2â€ï¼›æ®µå±æ€§ä¸ºåªè¯»ï¼Œå¹¶æŒ‰å­—èŠ‚å¯¹é½ï¼›</li>
    <li><strong>LOAD</strong>ï¼Œæ­¤ç±»å‹headerå…ƒç´ æè¿°äº†å¯åŠ è½½åˆ°è¿›ç¨‹ç©ºé—´çš„ä»£ç æ®µæˆ–æ•°æ®æ®µï¼šç¬¬ä¸‰é¡¹ä¸ºä»£ç æ®µï¼Œæ–‡ä»¶å†…åç§»ä¸º0ï¼Œæ˜ å°„åˆ°è¿›ç¨‹åœ°å€0x400000å¤„ï¼Œä»£ç æ®µé•¿åº¦ä¸º0x764ä¸ªå­—èŠ‚ï¼Œå±æ€§ä¸ºåªè¯»å¯æ‰§è¡Œï¼Œæ®µåœ°å€æŒ‰2Mè¾¹ç•Œå¯¹é½ï¼›ç¬¬å››æ®µä¸ºæ•°æ®æ®µï¼Œæ–‡ä»¶å†…åç§»ä¸º0xe10ï¼Œæ˜ å°„åˆ°è¿›ç¨‹åœ°å€ä¸º0x600e10å¤„(æŒ‰2Må¯¹é½ç§»åŠ¨)ï¼Œæ–‡ä»¶å¤§å°ä¸º0x230ï¼Œå†…å­˜å¤§å°ä¸º0x238(å› ä¸ºå…¶å†…éƒ¨åŒ…å«äº†8å­—èŠ‚çš„bssæ®µï¼Œå³æœªåˆå§‹åŒ–æ•°æ®æ®µï¼Œè¯¥æ®µå†…å®¹ä¸å æ–‡ä»¶ç©ºé—´ï¼Œä½†åœ¨è¿è¡Œæ—¶éœ€è¦ä¸ºå…¶åˆ†é…ç©ºé—´å¹¶æ¸…é›¶)ï¼Œå±æ€§ä¸ºè¯»å†™ï¼Œæ®µåœ°å€ä¹ŸæŒ‰2Mè¾¹ç•Œå¯¹é½ã€‚</li>
    <li><strong>DYNAMIC</strong>ï¼Œæ­¤ç±»å‹headerå…ƒç´ æè¿°äº†åŠ¨æ€åŠ è½½æ®µï¼Œå…¶å†…éƒ¨é€šå¸¸åŒ…å«äº†ä¸€ä¸ªåä¸ºâ€.dynamicâ€çš„åŠ¨æ€åŠ è½½åŒºï¼›è¿™ä¹Ÿæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ æè¿°äº†ä¸åŠ¨æ€åŠ è½½ç›¸å…³çš„å„æ–¹é¢ä¿¡æ¯ï¼Œæˆ‘ä»¬å°†åœ¨åŠ¨æ€åŠ è½½ä¸­ä»‹ç»ã€‚è¯¥æ®µæ˜¯ä»æ–‡ä»¶åç§»0xe28å¤„å¼€å§‹ï¼Œé•¿åº¦ä¸º0x1d0ï¼Œå¹¶æ˜ å°„åˆ°è¿›ç¨‹çš„0x600e28ï¼›å¯è§è¯¥æ®µå’Œä¸Šä¸€ä¸ªæ•°æ®æ®µæ˜¯æœ‰é‡å çš„ã€‚</li>
  </ul>
</blockquote>

<p>â€ƒâ€ƒreadelfå‘½ä»¤è¿”å›å†…å®¹çš„ä¸‹åŠéƒ¨åˆ†ç»™å‡ºäº†å„æ®µ(segment)å’Œå„åŒº(section)ä¹‹é—´çš„åŒ…å«å…³ç³»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚INTERPæ®µåªåŒ…å«äº†â€.interpâ€åŒºï¼›ä»£ç æ®µåŒ…å«â€.interpâ€ã€â€.pltâ€ã€â€.textâ€ç­‰åŒºï¼›æ•°æ®æ®µåŒ…å«â€.dynamicâ€ã€â€.dataâ€ã€â€.bssâ€ç­‰åŒºï¼›DYNAMICæ®µåŒ…å«â€.dynamicâ€åŒºã€‚ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œæœ‰äº›åŒºè¢«åŒ…å«åœ¨å¤šä¸ªæ®µä¸­ã€‚</p>

<div align="center">
<img src="/images/posts/i440fx/elf-program-header2.jpg" height="100" width="800" />  
</div>

<h5 id="25-section-header-tableå®ä¾‹è§£æ"><strong>2.5. Section Header Tableå®ä¾‹è§£æ</strong></h5>

<p>â€ƒâ€ƒé’ˆå¯¹å„åŒºçš„æè¿°ä¿¡æ¯ç”±Section Header Tableæä¾›ï¼Œè¯¥æ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>

<div align="center">
<img src="/images/posts/i440fx/process2_4.jpg" height="200" width="300" />  
</div>

<p>â€ƒâ€ƒä¸‹é¢æˆ‘ä»¬å†é€šè¿‡readelf -Så‘½ä»¤çœ‹çœ‹ç¤ºä¾‹ç¨‹åºä¸­section header tableçš„å†…å®¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ç¤ºä¾‹ç¨‹åºå…±ç”Ÿæˆ30ä¸ªåŒºï¼ŒNameè¡¨ç¤ºæ¯ä¸ªåŒºçš„åå­—ï¼ŒTypeè¡¨ç¤ºæ¯ä¸ªåŒºçš„åŠŸèƒ½ï¼ŒAddressè¡¨ç¤ºæ¯ä¸ªåŒºçš„è¿›ç¨‹æ˜ å°„åœ°å€ï¼ŒOffsetè¡¨ç¤ºæ–‡ä»¶å†…åç§»ï¼ŒSizeè¡¨ç¤ºåŒºçš„å¤§å°ï¼ŒEntSizeè¡¨ç¤ºåŒºä¸­æ¯ä¸ªå…ƒç´ çš„å¤§å°(å¦‚æœè¯¥åŒºä¸ºä¸€ä¸ªæ•°ç»„çš„è¯ï¼Œå¦åˆ™è¯¥å€¼ä¸º0)ï¼ŒFlagsè¡¨ç¤ºæ¯ä¸ªåŒºçš„å±æ€§(å‚è§å›¾ä¸­æœ€åçš„è¯´æ˜)ï¼ŒLinkå’ŒInfoè®°å½•ä¸åŒç±»å‹åŒºçš„ç›¸å…³ä¿¡æ¯(ä¸åŒç±»å‹å«ä¹‰ä¸åŒï¼Œå…·ä½“å‚è§è§„èŒƒ)ï¼ŒAlignè¡¨ç¤ºåŒºçš„å¯¹é½å•ä½ã€‚</p>

<div align="center">
<img src="/images/posts/i440fx/elf-section-header1.jpg" height="600" width="600" />  
</div>

<div align="center">
<img src="/images/posts/i440fx/elf-section-header2.jpg" height="400" width="600" />  
</div>

<h5 id="26-string-tableå®ä¾‹è§£æ"><strong>2.6. String Tableå®ä¾‹è§£æ</strong></h5>

<p>â€ƒâ€ƒä»ä¸Šè¿°Section Header Tableç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°æœ‰ä¸€ç§ç±»å‹ä¸ºSTRTABçš„åŒº(åœ¨Section Header Tableä¸­çš„ä¸‹æ ‡ä¸º6,27,29)ã€‚æ­¤ç±»åŒºå«åšString Tableï¼Œå…¶ä½œç”¨æ˜¯é›†ä¸­è®°å½•å­—ç¬¦ä¸²ä¿¡æ¯ï¼Œå…¶å®ƒåŒºåœ¨éœ€è¦ä½¿ç”¨å­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œåªéœ€è¦è®°å½•å­—ç¬¦ä¸²èµ·å§‹åœ°å€åœ¨è¯¥String Tableè¡¨ä¸­çš„åç§»å³å¯ï¼Œè€Œæ— éœ€åŒ…å«æ•´ä¸ªå­—ç¬¦ä¸²å†…å®¹ã€‚</p>

<p>â€ƒâ€ƒæˆ‘ä»¬ä½¿ç”¨readelf -xè¯»å‡ºä¸‹æ ‡27åŒºçš„è¯¦ç»†å†…å®¹è§‚å¯Ÿï¼š</p>

<div align="center">
<img src="/images/posts/i440fx/elf-strtable1.jpg" height="400" width="600" />  
</div>

<p>â€ƒâ€ƒçº¢æ¡†å†…ä¸ºè¯¥åŒºå®é™…å†…å®¹ï¼Œå·¦ä¾§ä¸ºåŒºå†…åç§»åœ°å€ï¼Œåä¾§ä¸ºå¯¹åº”å†…å®¹çš„å­—ç¬¦è¡¨ç¤ºã€‚æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œè¿™é‡Œå…¶å®æ˜¯ä¸€å †å­—ç¬¦ä¸²ï¼Œè¿™äº›å­—ç¬¦ä¸²å¯¹åº”çš„å°±æ˜¯å„ä¸ªåŒºçš„åå­—ã€‚å› æ­¤section header tableä¸­æ¯ä¸ªå…ƒç´ çš„Nameå­—æ®µå…¶å®æ˜¯è¿™ä¸ªstring tableçš„ç´¢å¼•ã€‚å†å›å¤´çœ‹çœ‹ELF headerä¸­çš„e_shstrndxï¼Œå®ƒçš„å€¼æ­£å¥½å°±æ˜¯27ï¼ŒæŒ‡å‘äº†å½“å‰çš„string tableã€‚</p>

<p>â€ƒâ€ƒåŒç†å†æ¥çœ‹ä¸‹29åŒºçš„å†…å®¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°äº†â€mainâ€ã€â€say_helloâ€å­—ç¬¦ä¸²ï¼Œè¿™äº›æ˜¯æˆ‘ä»¬åœ¨ç¤ºä¾‹ä¸­æºç ä¸­å®šä¹‰çš„ç¬¦å·ï¼Œç”±æ­¤å¯ä»¥29åŒºæ˜¯åº”ç”¨è‡ªèº«çš„String Tableï¼Œè®°å½•äº†åº”ç”¨ä½¿ç”¨çš„å­—ç¬¦ä¸²ã€‚</p>

<div align="center">
<img src="/images/posts/i440fx/elf-strtable2.jpg" height="700" width="600" />  
</div>

<h5 id="27-symbol-tableå®ä¾‹è§£æ"><strong>2.7. Symbol Tableå®ä¾‹è§£æ</strong></h5>

<p>â€ƒâ€ƒSection Header Tableä¸­ï¼Œè¿˜æœ‰ä¸€ç±»SYMTAB(DYNSYM)åŒºï¼Œè¯¥åŒºå«ç¬¦å·è¡¨ã€‚ç¬¦å·è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ å¯¹åº”ä¸€ä¸ªç¬¦å·ï¼Œè®°å½•äº†æ¯ä¸ªç¬¦å·å¯¹åº”çš„å®é™…æ•°å€¼ä¿¡æ¯ï¼Œé€šå¸¸ç”¨åœ¨é‡å®šä½è¿‡ç¨‹ä¸­æˆ–é—®é¢˜å®šä½è¿‡ç¨‹ä¸­ï¼Œè¿›ç¨‹æ‰§è¡Œé˜¶æ®µå¹¶ä¸åŠ è½½ç¬¦å·è¡¨ã€‚ç¬¦å·è¡¨ä¸­æ¯ä¸ªå…ƒç´ å®šä¹‰å¦‚ä¸‹ï¼šnameè¡¨ç¤ºç¬¦å·å¯¹åº”çš„æºç å­—ç¬¦ä¸²ï¼Œä¸ºå¯¹åº”String Tableä¸­çš„ç´¢å¼•ï¼›valueè¡¨ç¤ºç¬¦å·å¯¹åº”çš„æ•°å€¼ï¼›sizeè¡¨ç¤ºç¬¦å·å¯¹åº”æ•°å€¼çš„ç©ºé—´å ç”¨å¤§å°ï¼›infoè¡¨ç¤ºç¬¦å·çš„ç›¸å…³ä¿¡æ¯ï¼Œå¦‚ç¬¦å·ç±»å‹(å˜é‡ç¬¦å·ã€å‡½æ•°ç¬¦å·)ï¼›shndxè¡¨ç¤ºä¸è¯¥ç¬¦å·ç›¸å…³çš„åŒºçš„ç´¢å¼•ï¼Œä¾‹å¦‚å‡½æ•°ç¬¦å·ä¸å¯¹åº”çš„ä»£ç åŒºç›¸å…³ã€‚</p>

<div align="center">
<img src="/images/posts/i440fx/process2_5.jpg" height="160" width="300" />  
</div>

<p>â€ƒâ€ƒæˆ‘ä»¬ç”¨readelf -sè¯»å‡ºç¤ºä¾‹ç¨‹åºä¸­çš„ç¬¦å·è¡¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚å¦‚çº¢æ¡†ä¸­å†…å®¹æ‰€ç¤ºï¼Œæˆ‘ä»¬ç¤ºä¾‹ç¨‹åºå®šä¹‰çš„mainå‡½æ•°ç¬¦å·å¯¹åº”çš„æ•°å€¼ä¸º0x400554ï¼Œå…¶ç±»å‹ä¸ºFUNCï¼Œå¤§å°ä¸º26å­—èŠ‚ï¼Œå¯¹åº”çš„ä»£ç åŒºåœ¨Section Header Tableä¸­çš„ç´¢å¼•ä¸º13ï¼›say_helloå‡½æ•°ç¬¦å·å¯¹åº”æ•°å€¼ä¸º0x400530ï¼Œå…¶ç±»å‹ä¸ºFUNCï¼Œå¤§å°ä¸º36å­—èŠ‚ï¼Œå¯¹åº”çš„ä»£ç åŒºä¹Ÿä¸º13ã€‚</p>

<div align="center">
<img src="/images/posts/i440fx/elf-symtable1.jpg" height="250" width="600" />  
</div>

<div align="center">
<img src="/images/posts/i440fx/elf-symtable2.jpg" height="250" width="600" />  
</div>

<h5 id="28-ä»£ç æ®µå®ä¾‹è§£æ"><strong>2.8. ä»£ç æ®µå®ä¾‹è§£æ</strong></h5>

<p>â€ƒâ€ƒåœ¨ç†è§£äº†String Tableå’ŒSymbol Tableçš„ä½œç”¨åï¼Œæˆ‘ä»¬é€šè¿‡objdumpåæ±‡ç¼–æ¥ç†è§£ä¸€ä¸‹.textä»£ç æ®µï¼š</p>

<div align="center">
<img src="/images/posts/i440fx/elf-main-code.jpg" height="300" width="600" />  
</div>

<p>â€ƒâ€ƒè¿™é‡Œæˆªå–äº†ä¸ç¤ºä¾‹ç¨‹åºç›¸å…³éƒ¨åˆ†ï¼Œæˆ‘ä»¬çœ‹åˆ°0x400530å’Œ0x400554ä¸¤å¤„å„å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œå…¶ç¬¦å·åˆ†åˆ«ä¸ºsay_helloå’Œmainï¼Œè¿™éƒ¨åˆ†ä¿¡æ¯å®é™…æ˜¯é€šè¿‡ç¬¦å·è¡¨è§£æè€Œæ¥çš„ï¼›åœ¨æ¶‰åŠåˆ°å†…å­˜åœ°å€çš„æŒ‡ä»¤ä¸­ï¼Œé™¤äº†å¯¹æ•°æ®æ®µåœ°å€çš„å¼•ç”¨æ˜¯é€šè¿‡ç»å¯¹åœ°å€è¿›è¡Œçš„ä¹‹å¤–ï¼Œå¯¹äºä»£ç æ®µåœ°å€çš„å¼•ç”¨éƒ½æ˜¯ä»¥ç›¸å¯¹åœ°å€çš„æ–¹å¼è¿›è¡Œçš„ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯åœ¨äºŒè¿›åˆ¶æ–‡ä»¶çš„é‡å®šä½è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸ç”¨ä¿®æ”¹æŒ‡ä»¤çš„è®¿é—®åœ°å€(å› ä¸ºç›¸å¯¹åœ°å€ä¿æŒä¸å˜)ï¼›æœ€åï¼Œæˆ‘ä»¬çœ‹åˆ°å¯¹äºåº“å‡½æ•°printfçš„è®¿é—®æŒ‡å‘äº†ä»£ç æ®µåœ°å€0x400410ï¼Œé‚£ä¹ˆè¿™ä¸ªåœ°å€å¤„æ”¾çš„æ˜¯printfå‡½æ•°ä¹ˆï¼Ÿè¦å›ç­”è¿™ä¸ªé—®é¢˜å°±æ¶‰åŠåŠ¨æ€é“¾æ¥ï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹æ–‡ä¸“é¢˜åˆ†æã€‚</p>

<h5 id="29-åŠ¨æ€é“¾æ¥dynamic-linking"><strong>2.9. åŠ¨æ€é“¾æ¥(Dynamic Linking)</strong></h5>

<p>â€ƒâ€ƒåŸºäºæ¨¡å—åŒ–è®¾è®¡æ€è·¯ï¼Œæˆ‘ä»¬åœ¨åº”ç”¨å¼€å‘æ—¶ä¼šå°†åŸºç¡€çš„ã€å…±ç”¨çš„åŠŸèƒ½æŠ½å–å‡ºæ¥ï¼Œè®¾è®¡æˆå¯å…±äº«çš„åº“ã€‚åº”ç”¨ç¨‹åºåœ¨ç¼–è¯‘æ—¶åªæ˜¯å»ºç«‹äº†ä¸å…±äº«åº“çš„è”ç³»ï¼Œå¹¶ä¸å°†å…¶åŒ…å«åœ¨å†…ï¼›è¿è¡Œæ—¶ï¼Œç”±ç³»ç»Ÿè´Ÿè´£åŠ è½½æ‰€éœ€çš„å…±äº«åº“ã€‚è¿™å°±æ˜¯åŠ¨æ€é“¾æ¥ï¼Œå¦‚æ­¤ä¸€æ¥ï¼Œæ—¢å¯ä»¥èŠ‚çœç£ç›˜å’Œå†…å­˜çš„ç©ºé—´å ç”¨(ç›¸åŒåŠŸèƒ½åœ¨ç£ç›˜å’Œå†…å­˜ä¸­å‡åªå­˜åœ¨ä¸€ä»½)ï¼Œä¹Ÿå¯ä»¥æ–¹ä¾¿åŸºç¡€æ¨¡å—è‡ªèº«çš„ä¼˜åŒ–æ”¹è¿›ã€‚</p>

<p>â€ƒâ€ƒè¦å®ç°åŠ¨æ€é“¾æ¥ï¼Œéœ€è¦è§£å†³ä¸¤ä¸ªå¤§çš„é—®é¢˜ï¼š(1)å…±äº«åº“å†…éƒ¨çš„å‡½æ•°çš„åœ°å€è®¿é—®éœ€è¦ä¸åŠ è½½åœ°å€æ— å…³ï¼Œå› ä¸ºä¸åŒçš„ç¨‹åºå¯èƒ½å°†åº“åŠ è½½åˆ°ä¸åŒçš„åœ°å€å¤„ï¼›å›é¡¾2.8ä¸­çš„ä»£ç åˆ†æï¼Œæˆ‘ä»¬çœ‹åˆ°è¿™ä¸ªå¯ä»¥é€šè¿‡ç›¸å¯¹å¯»å€çš„æ–¹å¼è§£å†³ã€‚(2)è°ƒç”¨å…±äº«åº“çš„åº”ç”¨ç¨‹åºå¦‚ä½•èƒ½å¤Ÿè·çŸ¥å…±äº«åº“çš„åŠ è½½åœ°å€å¹¶å‡†ç¡®å¯¹å…¶è¿›è¡Œè°ƒç”¨ï¼Ÿ</p>

<p>â€ƒâ€ƒELFè§„èŒƒå¯¹é—®é¢˜2çš„è§£å†³æ–¹æ³•ç»™å‡ºæ˜ç¡®æ€è·¯ï¼šç³»ç»Ÿä¸­éœ€è¦æœ‰ä¸€ä¸ªProgram Interpreteré…åˆå†…æ ¸å®Œæˆè¿›ç¨‹æ‰§è¡Œä¸Šä¸‹æ–‡çš„å‡†å¤‡ã€‚Program Interpreterå¯ä»¥æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå…±äº«åº“ï¼›åœ¨Linux x86_64å¹³å°ä¸‹ï¼Œè¿™ä¸ªè§£æå™¨å°±æ˜¯/lib64/ld-ld-linux-x86-64.so.2ï¼Œå°±æ˜¯ç”±INTERPæ®µæŒ‡æ˜çš„ã€‚è§£æå™¨å’Œå†…æ ¸éœ€è¦é…åˆå®Œæˆä»¥ä¸‹åŠ¨ä½œï¼š</p>

<blockquote>
  <ul>
    <li>å†…æ ¸åŠ è½½å¯æ‰§è¡Œç¨‹åºå’Œè§£æå™¨åˆ°è¿›ç¨‹ç©ºé—´ï¼Œä¹‹åå°†æ§åˆ¶æƒäº¤ç»™è§£æå™¨ï¼›</li>
    <li>è§£æå™¨åŠ è½½å…±äº«åº“åˆ°è¿›ç¨‹ç©ºé—´ï¼›</li>
    <li>è§£æå™¨è¿›è¡Œé‡å®šä½ï¼›</li>
    <li>è§£æå™¨å°†æ§åˆ¶æƒäº¤ç»™è¿›ç¨‹æ­£å¸¸æ‰§è¡Œã€‚</li>
  </ul>
</blockquote>

<p>â€ƒâ€ƒè§£æå™¨å·¥ä½œæ—¶éœ€è¦ä»DYNAMICæ®µä¸­è·å–ä¿¡æ¯ï¼Œå¹¶é€šè¿‡GOT(Global Offset Table)è®°å½•è§£æåçš„åº“å‡½æ•°åœ°å€ï¼›åº”ç”¨ç¨‹åºé€šè¿‡PLT(Procedure Linkage Table)ä¸­çš„ä»£ç é—´æ¥è®¿é—®GOTï¼Œå¹¶æœ€ç»ˆå®Œæˆå‘ç›®æ ‡åº“å‡½æ•°çš„è·³è½¬ã€‚</p>

<p>â€ƒâ€ƒç»“åˆæˆ‘ä»¬çš„ç¤ºä¾‹ç¨‹åºï¼Œæˆ‘ä»¬é€šè¿‡readelf -dè·å–DYNAMICæ®µä¸­çš„ä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>

<div align="center">
<img src="/images/posts/i440fx/elf-dynamic.jpg" height="400" width="600" />  
</div>

<p>â€ƒâ€ƒé‡ç‚¹çœ‹ä¸€ä¸‹çº¢æ¡†ä¸­æ ‡å‡ºçš„ä¸¤è¡Œï¼ŒNEEDEDè¡¨ç¤ºå½“å‰å¯æ‰§è¡Œç¨‹åºä¾èµ–çš„å…±äº«åº“ï¼Œè¿™é‡Œåªæœ‰libc.so.6ä¸€é¡¹ï¼›PLTGOTè¡¨ç¤ºå½“å‰ç¨‹åºè°ƒç”¨å…±äº«åº“æ—¶ä½¿ç”¨çš„GOTè¡¨çš„åœ°å€ä¸º0x601000ï¼Œå›çœ‹å‰æ–‡çš„Section Header Tableï¼Œå¯çŸ¥å¯¹åº”åŒºçš„ç´¢å¼•ä¸º23ã€‚æˆ‘ä»¬æ¥ç€å¯ä»¥çœ‹çœ‹è¯¥åŒºçš„å†…å®¹ï¼š</p>

<div align="center">
<img src="/images/posts/i440fx/elf-dynamic-got.jpg" height="100" width="600" />  
</div>

<p>â€ƒâ€ƒä»23åŒºçš„section headerä¸­å¯çŸ¥è¯¥åŒºä¸ºä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ å¤§å°ä¸º8å­—èŠ‚ã€‚ç»“åˆè§„èŒƒä¸­çš„è¯´æ˜å¯çŸ¥ï¼ŒGOTä¸­çš„å‰ä¸‰ä¸ªå…ƒç´ æœ‰ç€ç‰¹æ®Šä½œç”¨ï¼šç¬¬ä¸€ä¸ªå…ƒç´ è½¬æ¢æˆåœ°å€ä¸º0x600e28ï¼Œå³ä¸ºDYNAMICæ®µçš„æ˜ å°„åœ°å€ï¼›ç¬¬äºŒå…ƒç´ å’Œç¬¬ä¸‰ä¸ªå…ƒç´ ä¼šåœ¨è§£æå™¨è·å¾—æ§åˆ¶æƒåè¢«æ”¾ç½®åŠ¨æ€è§£æå‡½æ•°çš„å‚æ•°å’Œå…¥å£åœ°å€ï¼Œå…¶ä½œç”¨å°†åœ¨åç»­è¯´æ˜PLTåŠŸèƒ½æ˜¯è¯´æ˜ã€‚ä»ç¬¬å››ä¸ªå…ƒç´ èµ·ï¼Œæ¯ä¸ªå…ƒç´ ä»£è¡¨ä¸€ä¸ªè°ƒç”¨åœ°å€ï¼Œä¾æ¬¡ä¸º0x400416ã€0x400426ã€0x400436ï¼Œè¿™äº›åœ°å€å¯¹åº”ä»€ä¹ˆå†…å®¹å‘¢ï¼Ÿ</p>

<p>â€ƒâ€ƒæˆ‘ä»¬é€šè¿‡objdumpæ¥çœ‹çœ‹.pltæ®µçš„å†…å®¹ï¼š</p>

<div align="center">
<img src="/images/posts/i440fx/elf-dynamic-plt.jpg" height="250" width="600" />  
</div>

<p>â€ƒâ€ƒpltåŒ…å«å‡ æ®µç›¸ä¼¼çš„æ±‡ç¼–æŒ‡ä»¤ï¼Œå›é¡¾å‰æ–‡ï¼Œ.textä»£ç æ®µçš„say_helloåœ¨è°ƒç”¨printfæ—¶è®¿é—®çš„å‡½æ•°åœ°å€å³ä¸º0x40010ï¼Œå¯¹åº”pltä¸­ç¬¬äºŒæ®µæ±‡ç¼–çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ã€‚è¿™æ˜¯ä¸€æ¡jumpæŒ‡ä»¤ï¼Œè·³è½¬åˆ°0x601018å³GOTè¡¨çš„ç¬¬4ä¸ªå…ƒç´ ã€‚å‰æ–‡åˆ†ææ—¶æŒ‡å‡ºï¼ŒGOTä¸­ç¬¬4ä¸ªå…ƒç´ ä¸º0x400416ï¼Œæ­£å¥½å¯¹åº”jumpæŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚æ„Ÿè§‰ä¸Šè½¬äº†ä¸€åœˆå´åªæ˜¯è·³åˆ°äº†ä¸‹ä¸€æ¡æŒ‡ä»¤å¤„ï¼Œæœ‰ç‚¹å¤šä½™ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥ç€å¾€ä¸‹åˆ†æã€‚åç»­çš„pushæŒ‡ä»¤æŠŠ0å‹å…¥äº†æ ˆä¸­(ä»£è¡¨æ¯ä¸ªè°ƒç”¨å‡½æ•°çš„ç´¢å¼•ï¼Œè¿™é‡Œprintfç´¢å¼•å€¼ä¸º0),ç„¶åè·³è½¬åˆ°pltè¡¨ä¸­çš„ç¬¬ä¸€æ®µæ±‡ç¼–æŒ‡ä»¤å¤„ã€‚è¿™é‡ŒæŠŠGOTè¡¨çš„ç¬¬äºŒä¸ªå…ƒç´ å‹åŠ›æ ˆä¸­ï¼Œç„¶åè·³è½¬åˆ°GOTè¡¨ä¸­ç¬¬ä¸‰ä¸ªå…ƒç´ æŒ‡å®šçš„å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°æ˜¯è§£æå™¨çš„åŠ¨æ€è§£æå‡½æ•°ï¼Œå®ƒçš„ä½œç”¨æ˜¯é’ˆå¯¹æ ˆä¸­çš„è°ƒç”¨å‡½æ•°ç´¢å¼•ï¼Œæ‰¾åˆ°è°ƒç”¨å‡½æ•°çš„å®é™…åŠ è½½åœ°å€ï¼Œå¹¶å°†è¯¥åœ°å€å¡«å…¥GOTè¡¨ä¸­å¯¹åº”çš„å…ƒç´ ä½ç½®(è¿™é‡Œå°±æ˜¯å°†printfçš„å®é™…åŠ è½½åœ°å€å¡«å…¥0x601018å¤„(å³GOTè¡¨ä¸­çš„ç¬¬4ä¸ªå…ƒç´ ))ï¼Œç„¶åè·³è½¬åˆ°printfå¤„æ‰§è¡Œã€‚å½“åº”ç”¨ç¨‹åºå†æ¬¡è°ƒç”¨printfæ—¶ï¼Œè·³è½¬åˆ°pltä¸­å¯¹åº”çš„å‡½æ•°åï¼Œé‚£é‡Œçš„jumpæŒ‡ä»¤å°†æ ¹æ®GOTè¡¨ä¸­è¢«è§£æå™¨æ›´æ–°åçš„åœ°å€ç›´æ¥è·³è½¬åˆ°printfå¤„å¼€å§‹æ‰§è¡Œï¼Œè¿™æ ·å°±ä¸ç”¨è§£æå™¨çš„å¹²é¢„äº†ï¼Œä»è€Œè¾¾åˆ°äº†åŠ¨æ€è·³è½¬çš„ç›®çš„ã€‚</p>

<p>â€ƒâ€ƒæˆ‘ä»¬å¯¹åŠ¨æ€è°ƒç”¨åšä¸ªæ€»ç»“ï¼š</p>

<blockquote>
  <ul>
    <li>éœ€è¦è¿›è¡ŒåŠ¨æ€è°ƒç”¨çš„å¯æ‰§è¡Œç¨‹åºåœ¨ç¼–è¯‘æ—¶ä¼šè‡ªåŠ¨ç”ŸæˆDYNAMICæ®µã€GOTè¡¨å’ŒPLTè¡¨ï¼›</li>
    <li>å¯¹åŠ¨æ€åº“çš„æ¯ä¸ªå‡½æ•°è°ƒç”¨éƒ½ä¼šåœ¨GOT(ä»ç¬¬4ä¸ªå…ƒç´ å¼€å§‹)å’ŒPLT(ä»ç¬¬äºŒæ®µæ±‡ç¼–æŒ‡ä»¤å¼€å§‹)ä¸­ç”Ÿæˆä¸€é¡¹ï¼›</li>
    <li>è§£æå™¨åœ¨è·å¾—æ§åˆ¶æƒåä¼šåœ¨GOTç¬¬2ä¸ªå…ƒç´ å’Œç¬¬3ä¸ªå…ƒç´ æ”¾ç½®è§£æå‡½æ•°çš„å‚æ•°å’Œå…¥å£åœ°å€ï¼›PLTçš„ç¬¬ä¸€æ®µæ±‡ç¼–æŒ‡ä»¤ä¼šå°†GOTç¬¬2ä¸ªå…ƒç´ å‹æ ˆå¹¶è·³è½¬åˆ°ç¬¬3ä¸ªå…ƒç´ æŒ‡å®šçš„å‡½æ•°ä½ç½®ï¼›</li>
    <li>è¿›è¡Œè¿‡ä¸€æ¬¡åŠ¨æ€è°ƒç”¨åï¼ŒGOTä¸­å¯¹åº”çš„å…ƒç´ ä¸­å°±è®°å½•äº†åº“å‡½æ•°çš„å®é™…åŠ è½½åœ°å€ï¼Œåç»­çš„è°ƒç”¨å°±å¯ä»¥è¿›è¡Œç›´æ¥è·³è½¬ã€‚</li>
  </ul>
</blockquote>

<h4 id="3-æ·±å…¥å†…æ ¸sys_execve"><strong>3. æ·±å…¥å†…æ ¸sys_execve</strong></h4>

<p>â€ƒâ€ƒæˆ‘ä»¬åœ¨2.9èŠ‚ä¸­ä»‹ç»è¿‡ï¼Œå†…æ ¸å’Œè§£æå™¨ç›¸äº’é…åˆå®Œäº†è¿›ç¨‹æ‰§è¡Œç©ºé—´çš„æ›¿æ¢ï¼Œä¸‹é¢æˆ‘ä»¬æ·±å…¥å†…æ ¸ä»£ç æ¥çœ‹çœ‹sys_execveçš„å®ç°åŸç†ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>linux/fs/exec.c:

SYSCALL_DEFINE3(execve,
        const char __user *, filename,
        const char __user *const __user *, argv,
        const char __user *const __user *, envp)
{
    struct filename *path = getname(filename);
    int error = PTR_ERR(path);
    if (!IS_ERR(path)) {
        error = do_execve(path-&gt;name, argv, envp);
        putname(path);
    }
    return error;
}

int do_execve(const char *filename,
            const char __user *const __user *__argv,
    const char __user *const __user *__envp)
{
    struct user_arg_ptr argv = { .ptr.native = __argv };
    struct user_arg_ptr envp = { .ptr.native = __envp };
    return do_execve_common(filename, argv, envp);
}

/*
 * sys_execve() executes a new program.
 */
static int do_execve_common(const char *filename,
                    struct user_arg_ptr argv,
                    struct user_arg_ptr envp)
{
    struct linux_binprm *bprm;
    struct file *file;
    struct files_struct *displaced;
    bool clear_in_exec;
    int retval;
    const struct cred *cred = current_cred();

    ...

    retval = -ENOMEM;
    bprm = kzalloc(sizeof(*bprm), GFP_KERNEL);
    if (!bprm)
        goto out_files;

    ...

    /*æ‰“å¼€å¯æ‰§è¡Œæ–‡ä»¶*/
    file = open_exec(filename);
    ...

    bprm-&gt;file = file;
    bprm-&gt;filename = filename;
    bprm-&gt;interp = filename;

    /*åˆå§‹åŒ–å°†æ›¿æ¢å½“å‰è¿›ç¨‹çš„mm_struct*/
    retval = bprm_mm_init(bprm);
    ...

    /*è®¡ç®—å‘½ä»¤è¡Œå‚æ•°å’Œç¯å¢ƒå˜é‡ä¸ªæ•°*/
    bprm-&gt;argc = count(argv, MAX_ARG_STRINGS);
    ...
    bprm-&gt;envc = count(envp, MAX_ARG_STRINGS);
    ...

    /*å‡†å¤‡bprmä¸­ç›¸å…³ä¿¡æ¯å¹¶è¯»å–å¯æ‰§è¡Œæ–‡ä»¶å¤´éƒ¨*/
    retval = prepare_binprm(bprm);
    ...

    /*å¤åˆ¶ä¿¡æ¯åˆ°ç”¨æˆ·æ ˆç©ºé—´*/
    retval = copy_strings_kernel(1, &amp;bprm-&gt;filename, bprm);
    ...
    bprm-&gt;exec = bprm-&gt;p;
    retval = copy_strings(bprm-&gt;envc, envp, bprm);
    ...
    retval = copy_strings(bprm-&gt;argc, argv, bprm);
    ...

    /*åœ¨å†…æ ¸ä¸­æœç´¢èƒ½å¤ŸåŠ è½½å½“å‰å¯æ‰§è¡Œæ–‡ä»¶çš„äºŒè¿›åˆ¶è§£æé©±åŠ¨ï¼Œè¿™é‡Œæ˜¯elfé©±åŠ¨ï¼Œ
      æœ€ç»ˆä¼šè°ƒç”¨elf_load_binary*/
    retval = search_binary_handler(bprm);
    ...

    return retval;
}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>linux/fs/binfmt_elf.c:

static int load_elf_binary(struct linux_binprm *bprm)
{
    struct file *interpreter = NULL; /* to shut gcc up */
    unsigned long load_addr = 0, load_bias = 0;
    int load_addr_set = 0;
    char * elf_interpreter = NULL;
    unsigned long error;
    struct elf_phdr *elf_ppnt, *elf_phdata;
    unsigned long elf_bss, elf_brk;
    int retval, i;
    unsigned int size;
    unsigned long elf_entry;
    unsigned long interp_load_addr = 0;
    unsigned long start_code, end_code, start_data, end_data;
    unsigned long reloc_func_desc __maybe_unused = 0;
    int executable_stack = EXSTACK_DEFAULT;
    unsigned long def_flags = 0;
    struct pt_regs *regs = current_pt_regs();
    struct {
        struct elfhdr elf_ex; /*è®°å½•å½“å‰å¯æ‰§è¡Œç¨‹åºçš„elf header*/
        struct elfhdr interp_elf_ex; /*è®°å½•ç¨‹åºè§£æå™¨çš„elf header*/
    } *loc;

    loc = kmalloc(sizeof(*loc), GFP_KERNEL);
    if (!loc) {
        retval = -ENOMEM;
        goto out_ret;
    }

    /* Get the exec-header */
    loc-&gt;elf_ex = *((struct elfhdr *)bprm-&gt;buf); /*å½“å‰å¯æ‰§è¡Œç¨‹åºå¤´éƒ¨128å­—èŠ‚å·²ç»è¯»åˆ°buffä¸­*/

    retval = -ENOEXEC;
    /* First of all, some simple consistency checks */
    if (memcmp(loc-&gt;elf_ex.e_ident, ELFMAG, SELFMAG) != 0) /*è¾ƒéªŒå¤´éƒ¨é­”æœ¯å­—*/
        goto out;

    if (loc-&gt;elf_ex.e_type != ET_EXEC &amp;&amp; loc-&gt;elf_ex.e_type != ET_DYN) /*æ ¡éªŒå¯æ‰§è¡Œæ–‡ä»¶ç±»å‹*/
        goto out;
    ...
    if (!bprm-&gt;file-&gt;f_op || !bprm-&gt;file-&gt;f_op-&gt;mmap)
        goto out;

    /* Now read in all of the header information */
    if (loc-&gt;elf_ex.e_phentsize != sizeof(struct elf_phdr)) /*æ ¡éªŒprogram headerå¤§å°*/
        goto out;
    if (loc-&gt;elf_ex.e_phnum &lt; 1 ||
            loc-&gt;elf_ex.e_phnum &gt; 65536U / sizeof(struct elf_phdr)) /*æ ¡éªŒprogram header ä¸ªæ•°*/
        goto out;
    size = loc-&gt;elf_ex.e_phnum * sizeof(struct elf_phdr);
    retval = -ENOMEM;
    elf_phdata = kmalloc(size, GFP_KERNEL);
    if (!elf_phdata)
        goto out;

    /*æ ¹æ®e_phoffè®°å½•çš„æ–‡ä»¶åç§»è¯»å–program header table*/
    retval = kernel_read(bprm-&gt;file, loc-&gt;elf_ex.e_phoff,
            (char *)elf_phdata, size);
    if (retval != size) {
        if (retval &gt;= 0)
            retval = -EIO;
        goto out_free_ph;
    }

    elf_ppnt = elf_phdata;
    elf_bss = 0;
    elf_brk = 0;

    start_code = ~0UL;
    end_code = 0;
    start_data = 0;
    end_data = 0;

    /*ä»program header tableä¸­æ‰¾å‡ºINTERPæ®µè·å–ç¨‹åºè§£æå™¨çš„è®¿é—®è·¯å¾„å¹¶åŠ è½½å…¶å¤´éƒ¨*/
    for (i = 0; i &lt; loc-&gt;elf_ex.e_phnum; i++) {
        if (elf_ppnt-&gt;p_type == PT_INTERP) {
            ...
            elf_interpreter = kmalloc(elf_ppnt-&gt;p_filesz, GFP_KERNEL);
            ...
            retval = kernel_read(bprm-&gt;file, elf_ppnt-&gt;p_offset, elf_interpreter,
                elf_ppnt-&gt;p_filesz);
            ...
            interpreter = open_exec(elf_interpreter);
            ...
            retval = kernel_read(interpreter, 0, bprm-&gt;buf, BINPRM_BUF_SIZE);

            loc-&gt;interp_elf_ex = *((struct elfhdr *)bprm-&gt;buf);
            break;
        }
        elf_ppnt++;
    }

    ...
    /* Some simple consistency checks for the interpreter */
    if (elf_interpreter) {
        ...
    }

    /* Flush all traces of the currently running executable */
    retval = flush_old_exec(bprm); /*æ›¿æ¢å½“å‰è¿›ç¨‹çš„mm_struct*/
    if (retval)
        goto out_free_dentry;

    ...

    setup_new_exec(bprm);

    ...
    retval = setup_arg_pages(bprm, randomize_stack_top(STACK_TOP), executable_stack);
    if (retval &lt; 0) {
        send_sig(SIGKILL, current, 0);
        goto out_free_dentry;
    }

    current-&gt;mm-&gt;start_stack = bprm-&gt;p;

    /* Now we do a little grungy work by mmapping the ELF image into
       the correct location in memory. */
    for(i = 0, elf_ppnt = elf_phdata; i &lt; loc-&gt;elf_ex.e_phnum; i++, elf_ppnt++) {
        int elf_prot = 0, elf_flags;
        unsigned long k, vaddr;
        unsigned long total_size = 0;

        if (elf_ppnt-&gt;p_type != PT_LOAD) /*åªå¤„ç†LOADæ®µ*/
            continue;

        ...
        /*æ ¹æ®æ®µçš„è¯»å†™å±æ€§è®¾ç½®elf_prot*/
        if (elf_ppnt-&gt;p_flags &amp; PF_R)
            elf_prot |= PROT_READ;
        if (elf_ppnt-&gt;p_flags &amp; PF_W)
            elf_prot |= PROT_WRITE;
        if (elf_ppnt-&gt;p_flags &amp; PF_X)
            elf_prot |= PROT_EXEC;

        elf_flags = MAP_PRIVATE | MAP_DENYWRITE | MAP_EXECUTABLE;

        vaddr = elf_ppnt-&gt;p_vaddr; /*æ®µæ˜ å°„çš„è¿›ç¨‹è™šæ‹Ÿåœ°å€ï¼Œä¾‹å¦‚ç¤ºä¾‹ç¨‹çš„ä»£ç æ®µæ˜ å°„åˆ°0x400000*/
        if (loc-&gt;elf_ex.e_type == ET_EXEC || load_addr_set) {
            elf_flags |= MAP_FIXED;
        } else if (loc-&gt;elf_ex.e_type == ET_DYN) {
            ...
        }

        /*å°†LOADæ®µæ˜ å°„åˆ°è¿›ç¨‹çš„vaddrå¤„*/
        error = elf_map(bprm-&gt;file, load_bias + vaddr, elf_ppnt,
                elf_prot, elf_flags, total_size);
        ...

        if (!load_addr_set) {
            load_addr_set = 1;
            load_addr = (elf_ppnt-&gt;p_vaddr - elf_ppnt-&gt;p_offset); /*æ®µèµ·å§‹æ˜ å°„ä½ç½®*/
            if (loc-&gt;elf_ex.e_type == ET_DYN) {
                ...
            }
        }
        /*ä¸‹é¢è¿™æ®µä»£ç ç”¨æ¥è®¡ç®—å„æ®µçš„åŠ è½½ä½ç½®ï¼Œé’ˆå¯¹ç¤ºä¾‹ç¨‹åºï¼š
           start_code = 0x400000;
           end_code = 0x40764;
           start_data = 0x600e10;
           end_data = 0x601040;
           elf_bss = 0x601040;
           elf_brk = 0x601048; */
        k = elf_ppnt-&gt;p_vaddr;
        if (k &lt; start_code)
            start_code = k;
        if (start_data &lt; k)
            start_data = k;

        ...
        k = elf_ppnt-&gt;p_vaddr + elf_ppnt-&gt;p_filesz;

        if (k &gt; elf_bss)
            elf_bss = k;
        if ((elf_ppnt-&gt;p_flags &amp; PF_X) &amp;&amp; end_code &lt; k)
            end_code = k;
        if (end_data &lt; k)
            end_data = k;
        k = elf_ppnt-&gt;p_vaddr + elf_ppnt-&gt;p_memsz;
        if (k &gt; elf_brk)
            elf_brk = k;
    }

    loc-&gt;elf_ex.e_entry += load_bias;
    elf_bss += load_bias;
    elf_brk += load_bias;
    start_code += load_bias;
    end_code += load_bias;
    start_data += load_bias;
    end_data += load_bias;

    /* Calling set_brk effectively mmaps the pages that we need
     * for the bss and break sections.  We must do this before
     * mapping in the interpreter, to make sure it doesn't wind
     * up getting placed where the bss needs to go.
     */
    retval = set_brk(elf_bss, elf_brk); /*ä¸ºbssæ˜ å°„åŒ¿åé¡µå¹¶æ¸…é›¶*/
    ...

    if (elf_interpreter) {
        unsigned long interp_map_addr = 0;
        
        /*elf_entryè®°å½•äº†execveè°ƒç”¨è¿”å›åå°†æ‰§è¡Œçš„å‡½æ•°å…¥å£ï¼Œè¿™é‡ŒæŒ‡å‘ç¨‹åºè§£æå™¨linux-ld*/
        elf_entry = load_elf_interp(&amp;loc-&gt;interp_elf_ex, interpreter, 
                &amp;interp_map_addr, load_bias);
        if (!IS_ERR((void *)elf_entry)) {
            interp_load_addr = elf_entry;
            elf_entry += loc-&gt;interp_elf_ex.e_entry;
        }
        ...
    }

    kfree(elf_phdata);

    set_binfmt(&amp;elf_format);

    /*åœ¨ç”¨æˆ·æ€æ ˆä¸­æ”¾å…¥elfè§£æè·å¾—çš„ç›¸å…³ä¿¡æ¯ï¼Œä¾›ç”¨æˆ·æ€ç¨‹åºä½¿ç”¨*/
    retval = create_elf_tables(bprm, &amp;loc-&gt;elf_ex, load_addr, interp_load_addr);
    ...
    /* N.B. passed_fileno might not be initialized? */
    current-&gt;mm-&gt;end_code = end_code;
    current-&gt;mm-&gt;start_code = start_code;
    current-&gt;mm-&gt;start_data = start_data;
    current-&gt;mm-&gt;end_data = end_data;
    current-&gt;mm-&gt;start_stack = bprm-&gt;p;
    ...

    /*ä¿®æ”¹regsæŒ‡å‘çš„æ ˆå¯„å­˜å™¨ï¼Œä½¿å¾—execveè°ƒç”¨è¿”å›åˆ°ç”¨æˆ·ç©ºé—´æ—¶ï¼Œå…¥å£å‡½æ•°ä¸ºelf_entryï¼Œæ ˆæŒ‡å‘bprm-&gt;p*/
    start_thread(regs, elf_entry, bprm-&gt;p);
    retval = 0;
out:
    kfree(loc);
out_ret:
    return retval;

/* error cleanup */
out_free_dentry:
    allow_write_access(interpreter);
    if (interpreter)
        fput(interpreter);
out_free_interp:
    kfree(elf_interpreter);
out_free_ph:
    kfree(elf_phdata);
goto out;
}
</code></pre></div></div>

<p>â€ƒâ€ƒè‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å°†è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸä¸­æœ€åŸºæœ¬çš„forkå’Œexecåˆ†æå®Œæˆï¼Œå†…å®¹è¾ƒå¤šï¼Œå»ºè®®å¤§å®¶å¤šæ€è€ƒå¤šç†è§£ï¼Œæ‰“å¥½åŸºç¡€ã€‚</p>

<p><br />
è½¬è½½è¯·æ³¨æ˜ï¼š<a href="https://rootw.github.io">å´æ–Œçš„åšå®¢</a> Â» <a href="https://rootw.github.io/2018/01/è¿›ç¨‹æ›¿æ¢/">ã€è®¡ç®—å­ç³»ç»Ÿã€‘è¿›ç¨‹ç®¡ç†ä¹‹äºŒï¼šè¿›ç¨‹æ›¿æ¢</a></p>
:ET