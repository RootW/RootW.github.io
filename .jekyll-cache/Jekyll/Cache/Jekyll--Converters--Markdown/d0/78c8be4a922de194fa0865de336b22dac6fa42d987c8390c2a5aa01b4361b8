I"¸V<p>â€ƒâ€ƒOSDè¿›ç¨‹é€šè¿‡ç½‘ç»œå¯¹Clientæä¾›æœåŠ¡ï¼Œå› æ­¤ç½‘ç»œå±‚æ˜¯OSDä¸­çš„åŸºç¡€å±‚ã€‚æœ¬ç¯‡åšæ–‡å°†è®¨è®ºcephä¸­ä¼ ç»Ÿçš„SimpleMessengerå®ç°åŸç†ã€‚</p>

<h3 id="simplemessengeræ¨¡å—ä¸­å¯¹è±¡æµç¨‹æ¦‚è§ˆ">SimpleMessengeræ¨¡å—ä¸­å¯¹è±¡ã€æµç¨‹æ¦‚è§ˆ</h3>

<p>â€ƒâ€ƒå¦‚æœå°†OSDè¿›ç¨‹çš„ç½‘ç»œæœåŠ¡æ¨¡å¼é…ç½®æˆSimpleMessengerï¼Œé‚£ä¹ˆå®ƒé‡‡ç”¨çš„æ˜¯POSIXæ ‡å‡†ç½‘ç»œæ¥å£æ¥å®ç°ç½‘ç»œåŠŸèƒ½ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ­¤æ—¶æˆ‘ä»¬çš„OSDæœåŠ¡ä»ä»£ç å®ç°æµç¨‹ä¸Šæ¥è¯´å°±æ˜¯é€šè¿‡socket()-&gt;bind()-&gt;listen()-&gt;accept()è¿›è¡Œè¿æ¥å»ºç«‹ï¼Œéšåå†é€šè¿‡æ¯ä¸ªè¿æ¥è¿›è¡Œç½‘ç»œæ¶ˆæ¯çš„æ”¶å‘ã€‚è™½ç„¶SimpleMessengeråœ¨å®ç°è¿‡ç¨‹ä¸­èå…¥ä¸€äº›è®¾è®¡æ¨¡å¼çš„æŠ½è±¡ï¼Œä½†æ˜¯æŠ“ä½ä»¥ä¸ŠPOSIXç½‘ç»œç¼–ç¨‹æ ¸å¿ƒæµç¨‹åå°†ä¾¿äºå¤§å®¶ç†è§£å…¶å®ç°æœºç†ã€‚</p>

<p>â€ƒâ€ƒæˆ‘ä»¬å…ˆæ•´ä½“æ¥çœ‹ä¸€ä¸‹SimpleMessengerçš„å¯¹è±¡å’Œæµç¨‹ï¼š</p>

<div align="center">
<img src="/images/posts/ceph/rbd_osd_simplemessenger.jpg" height="450" width="750" />  
</div>

<p>â€ƒâ€ƒæˆ‘ä»¬çŸ¥é“ä¸€ä¸ªcephé›†ç¾¤ä¸­é€šå¸¸ä¼šæœ‰ä¸¤ä¸ªç½‘ç»œå¹³é¢ï¼špublicå’Œclusterï¼Œé‚£ä¹ˆæ¯ä¸ªOSDè¿›ç¨‹ä¸­å°±ä¼šå¯¹åº”äº§ç”Ÿä¸¤ä¸ªmessengerå¯¹è±¡ms_publicå’Œms_clusterã€‚å¯¹äºæ¯ä¸ªmessengerå¯¹è±¡(è¿™é‡Œå…¶å®ä¸ºSimpleMessengerå¯¹è±¡)ï¼Œä¼šäº§ç”Ÿä¸€ä¸ªåä¸ºms_accepterçš„çº¿ç¨‹ï¼Œmessengerå¯¹è±¡é€šè¿‡accepteræˆå‘˜å˜é‡æŒ‡å‘è¯¥çº¿ç¨‹ã€‚ms_accepterçº¿ç¨‹æ˜¯åœ¨å®Œæˆsocket()-&gt;bind()-&gt;listen()åŠ¨ä½œä¹‹åäº§ç”Ÿï¼Œå®ƒçš„ä¸»è¦ä½œç”¨å°±æ˜¯ä¸€ç›´ç›‘å¬Clientç«¯çš„ç½‘ç»œè¿æ¥è¯·æ±‚ã€‚</p>

<p>â€ƒâ€ƒå½“æŸä¸€ä¸ªClientå‘èµ·è¿æ¥è¯·æ±‚åï¼Œms_accepterå°†è°ƒç”¨accept()æ¥å—è¯·æ±‚ï¼Œå¹¶ä¸ºè¯¥è¿æ¥äº§ç”Ÿä¸€ä¸ªpipeå¯¹è±¡ã€‚pipeå¯¹è±¡æ˜¯å¯¹TCP socketè¿æ¥çš„å°è£…ï¼Œå¯ä»¥å®ç°æ•…éšœé‡è¿ç­‰å¯é æ€§å¢å¼ºç‰¹æ€§ã€‚æ¯ä¸ªpipeå¯¹è±¡ä¼šäº§ç”Ÿä¸¤ä¸ªçº¿ç¨‹ï¼šä¸€ä¸ªå«ms_pipe_readçº¿ç¨‹ï¼Œå®ƒä¸€ç›´åœ¨ç›‘å¬socketè¿æ¥ä¸­çš„æ¶ˆæ¯ï¼Œå¦‚æœå‘ç°æœ‰æ¶ˆæ¯å®ƒå°†å–å‡ºæ¶ˆæ¯å¹¶å°†æ¶ˆæ¯æ”¾å…¥in_qä¸­è¿›è¡Œåˆ†å‘å¤„ç†ï¼›å¦ä¸€ä¸ªå«ms_pipe_writeçº¿ç¨‹ï¼Œå®ƒä¸€ç›´åœ¨ç­‰å¾…out_qä¸­è¢«æ”¾å…¥å‘é€æ¶ˆæ¯ï¼Œå¦‚æœå‘ç°out_qä¸­æœ‰æ¶ˆæ¯ï¼Œå®ƒå°†æŠŠæ¶ˆæ¯å–å‡ºå¹¶é€šè¿‡socketè¿æ¥å°†å…¶å‘é€å‡ºå»ã€‚</p>

<p>â€ƒâ€ƒåœ¨æ¶ˆæ¯æ¥æ”¶å¤„ç†çš„è¿‡ç¨‹ä¸­ï¼Œin_qé˜Ÿåˆ—æŒ‡å‘çš„å…¶å®æ˜¯SimpleMessengerå¯¹è±¡ä¸­çš„DispatchQueueï¼Œä¹Ÿå°±æ˜¯è¯´å¯¹äºåŒä¸€ä¸ªmessengerä¸­çš„å¤šä¸ªpipeï¼Œå®ƒä»¬æ¥æ”¶çš„æ¶ˆæ¯å°†è¢«æ”¾å…¥åˆ°åŒä¸€ä¸ªé˜Ÿåˆ—ä¸­ç­‰å¾…å¤„ç†ã€‚DispatchQueueåˆ†å‘æ¶ˆæ¯æ—¶å¦‚æœå‘ç°è¯¥æ¶ˆæ¯å¯ä»¥è¢«å¿«é€Ÿå¤„ç†(fast dispatch)æ—¶ï¼Œä¼šå°†è¯¥æ¶ˆæ¯ç›´æ¥åˆ†å‘ç»™SimpleMessengerï¼Œç”±SimpleMessengerå°†æ¶ˆæ¯åˆ†å‘ç»™å…¶å†…éƒ¨çš„å¤šä¸ªDispatcherå¯¹è±¡è¿›è¡Œæœ€ç»ˆçš„æ¶ˆæ¯å¤„ç†ã€‚è¿™é‡ŒOSDæ¨¡å—ä¸­çš„OSDå¯¹è±¡å°±æ˜¯å±äºSimpleMessengerçš„ä¸€ä¸ªDispatcherï¼ŒOSDå¯¹æ¶ˆæ¯çš„å¤„ç†å±äºOSDæ¨¡å—çš„å†…å®¹ï¼Œæˆ‘ä»¬å°†åœ¨åç»­åšæ–‡ä¸­ä»‹ç»ã€‚DispatchQueueå¦‚æœå‘ç°è¯¥æ¶ˆæ¯æ— æ³•è¢«å¿«é€Ÿå¤„ç†ï¼Œåˆ™ä¼šå°†è¯¥æ¶ˆæ¯äº¤ç»™DispatchQueueå¯¹åº”çš„DispatchThreadå¤„ç†ã€‚DispatchThreadçº¿ç¨‹å–å‡ºæ¶ˆæ¯åä¼šä¼ é€’ç»™messengeré€šè¿‡ms_deliver_dispatchè¿›è¡Œæ™®é€šå¤„ç†ï¼Œå…¶å®æœ€ç»ˆä¹Ÿä¼šäº¤ç»™Dispatcher(å¦‚OSDå¯¹è±¡)å¤„ç†ï¼Œåªä¸è¿‡æ˜¯åœ¨DispatchThreadçº¿ç¨‹ä¸­è¢«å¤„ç†(fast dispatchæ˜¯åœ¨ms_pipe_readçº¿ç¨‹ä¸­è¢«å¤„ç†ï¼Œè¯·å¤§å®¶æ³¨æ„å¯¹æ¯”)ã€‚</p>

<h3 id="simplemessengeræ¨¡å—ä¸­ç±»çš„æ¦‚è§ˆ">SimpleMessengeræ¨¡å—ä¸­ç±»çš„æ¦‚è§ˆ</h3>

<p>â€ƒâ€ƒåœ¨äº†è§£äº†SimpleMessengerçš„å®ç°æµç¨‹åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å®ƒçš„ç±»å®šä¹‰ï¼Œä»è€Œç†è§£å®ƒæ˜¯å¦‚ä½•å®ç°æŠ½è±¡ï¼Œä»¥æ”¯æŒæœªæ¥æ›´çµæ´»çš„æ‰©å±•ï¼š</p>

<div align="center">
<img src="/images/posts/ceph/rbd_osd_simplemessenger_class.jpg" height="750" width="750" />  
</div>

<p>â€ƒâ€ƒå›¾ä¸­æ ‡çº¢çš„ç±»(Messengerã€Dispatcherã€DispatchQueueã€Connection)å±äºMessengeræ¨¡å—æŠ½è±¡ç±»(ä¸å±äºæŸä¸€ç§ç½‘ç»œå®ç°æ¨¡å¼)ï¼Œä¸åŒçš„ç½‘ç»œå®ç°æ¨¡å¼å¯ä»¥ç»§æ‰¿å®ƒä»¬å®ç°å„è‡ªç‰¹æœ‰çš„åŠŸèƒ½ã€‚</p>

<blockquote>
  <ul>
    <li>Messengerç±»æ˜¯SimpleMessengerã€AsyncMessengerã€XioMessengerçš„çˆ¶ç±»ï¼Œå®ƒæç»˜äº†messengerå¯¹è±¡çš„åŠŸèƒ½æ¡†æ¶ã€‚æ¯ä¸ªmessengerå¯¹è±¡åŒ…å«ä¸¤ä¸ªDispatcheré“¾è¡¨ï¼Œdispatchersä»£è¡¨æ™®é€šå¤„ç†å¯¹è±¡ï¼Œfast_dispatchersä»£è¡¨å¿«é€Ÿå¤„ç†å¯¹è±¡ï¼Œä»¥ä¾¿å®ç°é’ˆå¯¹ä¸åŒæ¶ˆæ¯ç±»å‹é‡‡ç”¨ä¸åŒå¤„ç†æ–¹å¼çš„åŠŸèƒ½ã€‚Dispatcherå¯¹è±¡æ˜¯åœ¨åˆå§‹æµç¨‹ä¸­ï¼Œé€šè¿‡add_dispatcher_headeræ–¹æ³•è¢«åŠ å…¥åˆ°messengerå¯¹åº”çš„é“¾è¡¨ã€‚createã€bindã€startã€readyæ–¹æ³•å®ç°messengerå¯¹è±¡çš„åˆ›å»ºå’Œåˆå§‹åŒ–ï¼›waitç­‰å¾…messengerç”Ÿå‘½å‘¨æœŸç»“æŸï¼›shutdownå…³é—­messengerå¯¹è±¡ã€‚send_messageå®ç°äº†é€šè¿‡messengerå¯¹è±¡å‘é€ä¸€ä¸ªæ¶ˆæ¯çš„åŠŸèƒ½ã€‚ms_fast_dispatchå®ç°æ¶ˆæ¯çš„å¿«é€Ÿåˆ†å‘ï¼›ms_deliver_dispatchå®ç°æ¶ˆæ¯çš„æ™®é€šåˆ†å‘ï¼›æœ€ç»ˆéƒ½å°†åˆ†å‘ç»™messengerä¸­çš„dispatchersè¿›è¡Œå¤„ç†ã€‚</li>
    <li>Dispatcherç±»æ˜¯æ¥æ”¶æ¶ˆæ¯çš„å¤„ç†è€…ã€‚ä¸åŒæ¨¡å—å¯ä»¥å®ç°å„è‡ªä¸åŒçš„Dispatcherï¼Œä»¥å®ç°å¯¹æ¶ˆæ¯çš„ä¸åŒå¤„ç†é€»è¾‘ã€‚åªè¦åœ¨åˆå§‹åŒ–æ—¶é€šè¿‡messengerå¯¹è±¡çš„add_dispatcher_*æ–¹æ³•è¢«åŠ å…¥åˆ°messengerä¸­ï¼Œä¾¿å¯ä¿è¯è¯¥Dispatcherå¯ä»¥æ¥æ”¶åˆ°æ¶ˆæ¯å¹¶è¿›è¡Œå¤„ç†ã€‚</li>
    <li>DispatchQueueç±»å®ç°äº†ä¸€ä¸ªåˆ†å‘é˜Ÿåˆ—ã€‚ç”¨æˆ·é€šè¿‡enqueueæ“ä½œå°†æ¶ˆæ¯æ”¾å…¥é˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—å¯ä»¥æŒ‰ä¼˜å…ˆçº§å¯¹æ¶ˆæ¯è¿›è¡Œæ’åº(PrioritizeQueue)ã€‚é˜Ÿåˆ—ä¼šäº§ç”Ÿä¸€ä¸ªä¸“é—¨çš„DispatchThreadçº¿ç¨‹ï¼Œç”±è¯¥çº¿ç¨‹è´Ÿè´£ä»PrioritizedQueueä¸­å–å‡ºæ¶ˆæ¯è¿›è¡Œåˆ†å‘å¤„ç†ã€‚æ­¤å¤–ï¼ŒDispatchQueueä¹Ÿå¯é€šè¿‡can_fast_dispatchåˆ¤æ–­æ¶ˆæ¯æ˜¯å¦å¯ä»¥è¢«å¿«é€Ÿå¤„ç†ï¼Œå¦‚æœå¯ä»¥è¢«å¿«é€Ÿå¤„ç†ï¼Œåˆ™ç›´æ¥è°ƒç”¨fast_dispatchè¿›è¡Œåˆ†å‘å¤„ç†ï¼Œå¦åˆ™è°ƒç”¨enqueueè¿›é˜Ÿåˆ—äº¤ç”±DispatchThreadå¤„ç†ã€‚</li>
    <li>Connectionç±»æ˜¯å¯¹ç½‘ç»œè¿æ¥çš„æŠ½è±¡ã€‚å­ç±»é€šè¿‡å®ç°send_messageæ–¹æ³•æä¾›ä¸åŒçš„ç½‘ç»œå‘é€æ–¹æ¡ˆã€‚</li>
    <li>SimpleMessengerç±»ç»§æ‰¿Messengerç±»å®ç°åŸºäºPOSIXç½‘ç»œæ¥å£çš„ç½‘ç»œä¿¡ä½¿åŠŸèƒ½ã€‚å®ƒå°†å®ç°Messengerç±»ä¸­çš„bindã€startã€readyæ–¹æ³•ï¼Œä»¥å®Œæˆç½‘ç»œsocketçš„åˆå§‹åŒ–ã€‚ç‹¬æœ‰çš„Accepterå¯¹è±¡å°†äº§ç”Ÿä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ç›‘å¬ç½‘ç»œè¿æ¥è¯·æ±‚ã€‚æ¯å½“æ¥å—ä¸€ä¸ªæ–°è¿æ¥æ—¶ï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„Pipeå¯¹è±¡ï¼Œå¹¶é€šè¿‡add_accept_pipeæ–¹æ³•å°†å…¶åŠ å…¥åˆ°pipesåˆ—è¡¨ä¸­ã€‚SimpleMessengeråŒ…å«äº†ä¸€ä¸ªDispatchQueueæ¥å®ç°æ¶ˆæ¯çš„æ™®é€šåˆ†å‘å’Œå¿«é€Ÿåˆ†å‘ã€‚</li>
    <li>Pipeç±»ä»£è¡¨ä¸€ä¸ªè¿æ¥ä¼šè¯ï¼Œæ¯ä¸ªè¿æ¥ä¼šäº§ç”Ÿä¸€ä¸ªreader_threadçº¿ç¨‹(å…¥å£å‡½æ•°ä¸ºreader()æ–¹æ³•)å’Œä¸€ä¸ªwriter_threadçº¿ç¨‹(å…¥å£å‡½æ•°ä¸ºwriter())ã€‚readeræ–¹æ³•è´Ÿè´£ä»ç½‘ç»œå±‚æ¥æ”¶æ¶ˆæ¯æ”¾å…¥in_qå¹¶è¿›è¡Œé¡¶å±‚åˆ†å‘å¤„ç†ï¼›writeræ–¹æ³•è´Ÿè´£å°†out_qä¸­æ¶ˆæ¯é€šè¿‡ç½‘ç»œå‘é€ã€‚acceptæ–¹æ³•åœ¨æ¥å—è¿æ¥æ—¶è°ƒç”¨ï¼Œconnectæ–¹æ³•åœ¨å‘èµ·è¿æ¥è¯·æ±‚æ—¶è°ƒç”¨ã€‚</li>
    <li>Threadç±»æ˜¯Commonæ¨¡å—ä¸­çš„å…¬å…±ç±»ï¼Œç”¨æ¥ç”Ÿæˆçº¿ç¨‹ã€‚createæ–¹æ³•ç”¨æ¥åˆ›å»ºçº¿ç¨‹å¯¹è±¡ï¼›entryæ–¹æ³•ä¸ºæ–°çº¿ç¨‹çš„å…¥å£å‡½æ•°ï¼›joinæ–¹æ³•åœ¨ç­‰å¾…å­çº¿ç¨‹ç»“æŸæ—¶è°ƒç”¨ã€‚</li>
  </ul>
</blockquote>

<h3 id="ä»£ç è¯¦è§£">ä»£ç è¯¦è§£</h3>

<p>â€ƒâ€ƒæœ‰äº†å¯¹SimpleMessengeræ¨¡å—ä¸­å¯¹è±¡ã€æµç¨‹å’Œç±»çš„æ•´ä½“è®¤è¯†ä¹‹åï¼Œæˆ‘ä»¬å†ç»“åˆä»£ç æ¥æ·±å…¥ç†è§£å…¶å®ç°ç»†èŠ‚ã€‚</p>

<h4 id="1-åˆå§‹åŒ–è¿‡ç¨‹"><strong>1. åˆå§‹åŒ–è¿‡ç¨‹</strong></h4>

<p>â€ƒâ€ƒSimpleMessengeræ¨¡å—çš„åˆå§‹åŒ–åœ¨OSDè¿›ç¨‹çš„mainå‡½æ•°ä¸­å®Œæˆï¼Œæ•´ä½“è°ƒç”¨æ ˆå¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ceph_osd.cc:main()
    |-Messenger::create()
    |   \-SimpleMessenger::SimpleMessenger()
    |-Messenger::bind() -&gt; SimpleMessenger::bind()
    |   \-Accepter::bind()
    |       |-::socket()
    |       |-::bind()
    |       \-::listen()
    |-OSD::OSD()
    |-Messenger::start() -&gt; SimpleMessenger::start()
    |-OSD::init()
    |   \-Messenger::add_dispatcher_head()
    |       \-Messenger::ready() -&gt; SimpleMessenger::ready()
    |           \-Accepter::start()
    \-Messenger::wait() -&gt; SimpleMessenger::wait()
    
</code></pre></div></div>

<p>â€ƒâ€ƒæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ceph_osd.ccä¸­mainå‡½æ•°é‡Œå’ŒMessengeråˆå§‹åŒ–ç›¸å…³çš„éƒ¨åˆ†ä»£ç ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ceph/src/ceph_osd.cc:

int main(int argc, const char **argv)
{
    ...

    /*è¿™é‡Œæˆ‘ä»¬å‡è®¾public_msgr_typeå’Œcluster_msgr_typeéƒ½ä¸ºSimple*/
    std::string public_msgr_type = g_conf-&gt;ms_public_type.empty() ? g_conf-&gt;get_val&lt;std::string&gt;("ms_type") : g_conf-&gt;ms_public_type;
    std::string cluster_msgr_type = g_conf-&gt;ms_cluster_type.empty() ? g_conf-&gt;get_val&lt;std::string&gt;("ms_type") : g_conf-&gt;ms_cluster_type;

    /*æ ¹æ®ä¸åŒç±»å‹åˆ›å»ºmessengerå¯¹è±¡ï¼Œè¿™é‡Œå°†åˆ›å»ºä¸¤ä¸ªSimpleMessengerå¯¹è±¡*/
    Messenger *ms_public = Messenger::create(g_ceph_context, public_msgr_type,
        entity_name_t::OSD(whoami), "client",
        getpid(),
        Messenger::HAS_HEAVY_TRAFFIC |
        Messenger::HAS_MANY_CONNECTIONS);
    Messenger *ms_cluster = Messenger::create(g_ceph_context, cluster_msgr_type,
        entity_name_t::OSD(whoami), "cluster",
        getpid(),
        Messenger::HAS_HEAVY_TRAFFIC |
        Messenger::HAS_MANY_CONNECTIONS);

    ...

    /*ä¸ºmessengerå¯¹è±¡ç»‘å®šIPåœ°å€ï¼Œæœ€ç»ˆä¼šè°ƒç”¨Accepter::bindå‡½æ•°ï¼Œç”±å®ƒè°ƒç”¨ç³»ç»Ÿçš„socket()ã€bind()å’Œlisten()å‡½æ•°*/
    r = ms_public-&gt;bind(g_conf-&gt;public_addr);
    ...
    r = ms_cluster-&gt;bind(g_conf-&gt;cluster_addr);

    ...

    /*å°†åˆ›å»ºçš„ms_publicå’Œms_clusterä¼ é€’ç»™OSDæ„é€ å‡½æ•°ï¼Œå»ºç«‹ä¸€ä¸ªæ–°çš„OSDå¯¹è±¡*/
    osd = new OSD(g_ceph_context,
                store,
                whoami,
                ms_cluster,
                ms_public,
                ms_hb_front_client,
                ms_hb_back_client,
                ms_hb_front_server,
                ms_hb_back_server,
                ms_objecter,
                &amp;mc,
                g_conf-&gt;osd_data,
                g_conf-&gt;osd_journal);

    /*å¯åŠ¨messengerå¯¹è±¡ï¼Œé’ˆå¯¹SimpleMessengerï¼Œå…¶å†…éƒ¨ç»†èŠ‚æˆ‘ä»¬æš‚ä¸ç”¨å…³å¿ƒ*/
    ms_public-&gt;start();
    ...
    ms_cluster-&gt;start();

    /*OSDæ‰§è¡Œåˆå§‹åŒ–ï¼Œä¸‹æ–‡å°†å±•å¼€*/
    osd-&gt;init();

    ...

    /*æ•´ä¸ªåˆå§‹åŒ–åŠ¨ä½œå®Œæˆï¼ŒOSDä¸»çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€*/
    ms_public-&gt;wait();
    ms_cluster-&gt;wait();
    ...
}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ceph/src/msg/Messenger.cc:

Messenger *Messenger::create(CephContext *cct, const string &amp;type,
        entity_name_t name, string lname,
        uint64_t nonce, uint64_t cflags)
{
    int r = -1;
    if (type == "random") {
        static std::random_device seed;
        static std::default_random_engine random_engine(seed());
        static Spinlock random_lock;

        std::lock_guard&lt;Spinlock&gt; lock(random_lock);
        std::uniform_int_distribution&lt;&gt; dis(0, 1);
        r = dis(random_engine);
    }
    if (r == 0 || type == "simple")
        return new SimpleMessenger(cct, name, std::move(lname), nonce);
    else if (r == 1 || type.find("async") != std::string::npos)
        return new AsyncMessenger(cct, name, type, std::move(lname), nonce);
#ifdef HAVE_XIO
    else if ((type == "xio") &amp;&amp;
            cct-&gt;check_experimental_feature_enabled("ms-type-xio"))
    return new XioMessenger(cct, name, std::move(lname), nonce, cflags);
#endif
    lderr(cct) &lt;&lt; "unrecognized ms_type '" &lt;&lt; type &lt;&lt; "'" &lt;&lt; dendl;
    return nullptr;
}
</code></pre></div></div>

<p>â€ƒâ€ƒæˆ‘ä»¬å†æ·±å…¥çœ‹çœ‹OSDåˆå§‹åŒ–è¿‡ç¨‹ä¸­ä¸Messengerç›¸å…³çš„éƒ¨åˆ†ä»£ç ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ceph/src/osd/OSD.cc:

int OSD::init()
{
    ...

    /*å°†OSDå¯¹è±¡è‡ªèº«åŠ åˆ°public messengerå’Œcluster messengerçš„dispatchersä¸­*/
    client_messenger-&gt;add_dispatcher_head(this);
    cluster_messenger-&gt;add_dispatcher_head(this);

    ...
}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ceph/src/msg/Messenger.h:

void add_dispatcher_head(Dispatcher *d) { 
    bool first = dispatchers.empty(); /*æ˜¯å¦ä¸ºæ·»åŠ åˆ°dispatchersé“¾è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Ÿ*/
    dispatchers.push_front(d); /*åŠ å…¥åˆ°dispatchers*/
    if (d-&gt;ms_can_fast_dispatch_any()) /*å¦‚æœå¯ä»¥è¿›è¡Œfast dispatchåˆ™åŠ å…¥åˆ°fast_dispatchersä¸­*/
        fast_dispatchers.push_front(d);
    if (first)
        ready(); /*å¦‚æœæ˜¯é¦–ä¸ªåŠ å…¥åˆ°dispatchersä¸­çš„å¯¹è±¡ï¼Œåˆ™è°ƒç”¨messengerå¯¹è±¡çš„ready()*/
}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ceph/src/msg/simple/SimpleMessenger.cc:

void SimpleMessenger::ready()
{
    ldout(cct,10) &lt;&lt; "ready " &lt;&lt; get_myaddr() &lt;&lt; dendl;
    dispatch_queue.start(); /*æ‹‰èµ·dispatch_queueå¯¹åº”çš„dispatch_thread*/

    lock.Lock();
    if (did_bind)
        accepter.start(); /*æ‹‰èµ·ms_accepterçº¿ç¨‹*/
    lock.Unlock();
}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ceph/src/msg/simple/Accept.cc:

int Accepter::start()
{
    ldout(msgr-&gt;cct,1) &lt;&lt; __func__ &lt;&lt; dendl;

    // start thread
    create("ms_accepter");

    return 0;
}
</code></pre></div></div>

<h4 id="2-è¿æ¥å»ºç«‹è¿‡ç¨‹"><strong>2. è¿æ¥å»ºç«‹è¿‡ç¨‹</strong></h4>

<p>â€ƒâ€ƒSimpleMessengerå¯¹è±¡åˆå§‹åŒ–å®Œæˆåï¼Œå°†æ‹‰èµ·ä¸€ä¸ªms_accepterçº¿ç¨‹å¤„ç†Clientç«¯çš„è¿æ¥è¯·æ±‚ï¼Œè¯¥çº¿ç¨‹å…¥å£å‡½æ•°ä¸ºAccepter::entryã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ceph/src/msg/simple/Accepter.cc:

void *Accepter::entry()
{
    int errors = 0;
    int ch;

    struct pollfd pfd[2];
    memset(pfd, 0, sizeof(pfd));

    pfd[0].fd = listen_sd;
    pfd[0].events = POLLIN | POLLERR | POLLNVAL | POLLHUP;
    pfd[1].fd = shutdown_rd_fd;
    pfd[1].events = POLLIN | POLLERR | POLLNVAL | POLLHUP;

    while (!done) {
        int r = poll(pfd, 2, -1); /*é€šè¿‡pollç³»ç»Ÿè°ƒç”¨ç­‰å¾…Clientè¿æ¥è¯·æ±‚*/

        ...

        if (done) break;

        // accept
        sockaddr_storage ss;
        socklen_t slen = sizeof(ss);
        int sd = ::accept(listen_sd, (sockaddr*)&amp;ss, &amp;slen); /*æ”¶åˆ°è¯·æ±‚åï¼Œacceptè¯¥è¿æ¥*/
        if (sd &gt;= 0) {
            ...
            msgr-&gt;add_accept_pipe(sd); /*å‘SimpleMessengerå¯¹è±¡ä¸­æ·»åŠ pipe*/
        } else {
            ...
        }
    }
}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ceph/src/msg/simple/SimpleMessenger.cc:

Pipe *SimpleMessenger::add_accept_pipe(int sd)
{
    lock.Lock();
    Pipe *p = new Pipe(this, Pipe::STATE_ACCEPTING, NULL);
    p-&gt;sd = sd;
    p-&gt;pipe_lock.Lock();
    p-&gt;start_reader(); /*æ‹‰èµ·pipeå¯¹è±¡çš„ms_pipe_readçº¿ç¨‹*/
    p-&gt;pipe_lock.Unlock();
    pipes.insert(p);
    accepting_pipes.insert(p);
    lock.Unlock();
    return p;
}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ceph/src/msg/simple/Pipe.cc:

void Pipe::start_reader()
{
    if (reader_needs_join) {
        reader_thread.join();
        reader_needs_join = false;
    }
    reader_running = true;
    reader_thread.create("ms_pipe_read", msgr-&gt;cct-&gt;_conf-&gt;ms_rwthread_stack_bytes);
}
</code></pre></div></div>

<h4 id="3-æ¶ˆæ¯æ¥æ”¶ä¸åˆ†å‘è¿‡ç¨‹"><strong>3. æ¶ˆæ¯æ¥æ”¶ä¸åˆ†å‘è¿‡ç¨‹</strong></h4>

<p>â€ƒâ€ƒæ¯ä¸ªpipeå¯¹è±¡çš„ms_pipe_readçº¿ç¨‹è¢«æ‹‰èµ·åï¼Œä¼šè¿›è¡Œä¼šè¯çš„åå•†è¿‡ç¨‹(å¯ä»¥å›é¡¾ä¸‹å‰æœŸClientç«¯RBDçš„messengeråˆ†æåšæ–‡)ï¼›å®Œæˆåå°†å¤„äºç­‰å¾…æ¥æ”¶æ¶ˆæ¯çš„çŠ¶æ€ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ceph/src/msg/simple/Pipe.cc:

void Pipe::reader()
{
    pipe_lock.Lock();

    if (state == STATE_ACCEPTING) {
        /*æ‰§è¡Œä¼šè¯åå•†è¿‡ç¨‹ï¼Œåå•†æˆåŠŸåä¼šæ‹‰èµ·ms_pipe_writeçº¿ç¨‹*/
        accept();
    }

    while (state != STATE_CLOSED &amp;&amp;
            state != STATE_CONNECTING) {

        // sleep if (re)connecting
        if (state == STATE_STANDBY) {
            /*å¦‚æœpipeçŠ¶æ€ä¸ºSTANDBYï¼Œè¯´æ˜åº•å±‚è¿æ¥æ•…éšœä¸”æš‚æ— æ¶ˆæ¯å¤„ç†ï¼Œåˆ™è¿›å…¥ç¡çœ */
            cond.Wait(pipe_lock);
            continue;
        }

        pipe_lock.Unlock();

        char tag = -1;
        /*å…ˆä»ç½‘ç»œè¿æ¥ä¸­è¯»å–ä¸€ä¸ªå­—èŠ‚çš„tag*/
        if (tcp_read((char*)&amp;tag, 1) &lt; 0) {
            pipe_lock.Lock();
            fault(true);
            continue;
        }
        
        /*æ ¹æ®tagå€¼è¿›è¡Œä¸åŒçš„å¤„ç†åŠ¨ä½œ*/
        if (tag == CEPH_MSGR_TAG_KEEPALIVE) {
            ...
            continue;
        }
        if (tag == CEPH_MSGR_TAG_KEEPALIVE2) {
            ...
            continue;
        }
        if (tag == CEPH_MSGR_TAG_KEEPALIVE2_ACK) {
            ...
            continue;
        }
        if (tag == CEPH_MSGR_TAG_ACK) {
            ...
            continue;
        }
        else if (tag == CEPH_MSGR_TAG_MSG) {
            /*é’ˆå¯¹æ¶ˆæ¯ï¼Œå…ˆä»ç½‘ç»œä¸­è¯»å–æ¶ˆæ¯å†…å®¹åˆ°mä¸­*/
            Message *m = 0;
            int r = read_message(&amp;m, auth_handler.get());

            pipe_lock.Lock();
            if (m-&gt;get_seq() &lt;= in_seq) {
                m-&gt;put();
                continue;
            }
            m-&gt;set_connection(connection_state.get());
            ...

            /*å¯¹æ¶ˆæ¯è¿›è¡Œé¢„å¤„ç†*/
            in_q-&gt;fast_preprocess(m);
            if (delay_thread) {
                ...
            } else {
                /*å¦‚æœæ¶ˆæ¯å¯ä»¥è¢«å¿«é€Ÿå¤„ç†ï¼Œåˆ™èµ°å¿«é€Ÿå¤„ç†æµç¨‹ï¼›å¦åˆ™å°±enqueueåˆ°in_qä¸­äº¤ç»™dispatch_threadå¤„ç†*/
                if (in_q-&gt;can_fast_dispatch(m)) {
                    reader_dispatching = true;
                    pipe_lock.Unlock();
                    in_q-&gt;fast_dispatch(m);
                    pipe_lock.Lock();
                    reader_dispatching = false;
                    ...
                } else {
                    in_q-&gt;enqueue(m, m-&gt;get_priority(), conn_id);
                }            
            }
        }
        ...
    }
    ...
}
</code></pre></div></div>
<p>â€ƒâ€ƒæ¶ˆæ¯çš„å¿«é€Ÿå¤„ç†æµç¨‹å¯ä»¥å›å¤´å‚è€ƒå‰æ–‡çš„å¯¹è±¡ã€æµç¨‹å›¾ã€‚</p>

<h4 id="4-æ¶ˆæ¯å‘é€è¿‡ç¨‹"><strong>4. æ¶ˆæ¯å‘é€è¿‡ç¨‹</strong></h4>

<p>â€ƒâ€ƒä»»ä½•æ¨¡å—æƒ³é€šè¿‡messengerå‘é€æ¶ˆæ¯æ—¶ï¼Œéƒ½å¯ä»¥è°ƒç”¨Messenger::send_mesageæ¥å®Œæˆã€‚å¯¹äºSimpleMessengerï¼Œå…¶å®ç°ä½“ä½äºSimpleMessenger.hï¼Œå‘é€æ˜¯ä¸€ä¸ªå¼‚æ­¥è¿‡ç¨‹ï¼Œå‘é€è€…åªä¼šå°†æ¶ˆæ¯æ”¾å…¥Pipeå¯¹è±¡çš„out_qä¸­ï¼Œéšåç”±ms_pipe_writeçº¿ç¨‹å®Œæˆå‘ç½‘ç»œåè®®æ ˆçš„å‘é€ã€‚</p>

<p>â€ƒâ€ƒå‘é€è€…çš„è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sender[any thread]
    \-SimpleMessenger::send_message()
        \-SimpleMessenger::_send_message()
            \-SimpleMessenger::submit_message()
                \-Pipe::_send()
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ceph/src/msg/simple/SimpleMessenger.h:

int send_message(Message *m, const entity_inst_t&amp; dest) override {
    return _send_message(m, dest);
}

int send_message(Message *m, Connection *con) {
    return _send_message(m, con);
}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ceph/src/msg/simple/SimpleMessenger.cc:

int SimpleMessenger::_send_message(Message *m, Connection *con)
{
    //set envelope
    m-&gt;get_header().src = get_myname();

    if (!m-&gt;get_priority()) m-&gt;set_priority(get_default_send_priority());

    submit_message(m, static_cast&lt;PipeConnection*&gt;(con),
                con-&gt;get_peer_addr(), con-&gt;get_peer_type(), false);
    return 0;
}

void SimpleMessenger::submit_message(Message *m, PipeConnection *con,
                const entity_addr_t&amp; dest_addr, int dest_type,
                bool already_locked)
{
    ...
    if (con) {
        Pipe *pipe = NULL;
        bool ok = static_cast&lt;PipeConnection*&gt;(con)-&gt;try_get_pipe(&amp;pipe);
        ...
        while (pipe &amp;&amp; ok) {
            // we loop in case of a racing reconnect, either from us or them
            pipe-&gt;pipe_lock.Lock(); // can't use a Locker because of the Pipe ref
            if (pipe-&gt;state != Pipe::STATE_CLOSED) {
                pipe-&gt;_send(m);
                pipe-&gt;pipe_lock.Unlock();
                pipe-&gt;put();
                return;
            }
        }
        ...
    }
}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ceph/src/msg/simple/Pipe.h:

void _send(Message *m) {
    assert(pipe_lock.is_locked());
    out_q[m-&gt;get_priority()].push_back(m);
    cond.Signal();
}
</code></pre></div></div>

<p>â€ƒâ€ƒms_pipe_writeçº¿ç¨‹å…¥å£å‡½æ•°ä¸ºPipe::writerï¼Œå…¶è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Pipe::writer()
    |-Pipe::_get_next_outgoing()
    \-Pipe::write_message()
        \-Pipe::do_sendmsg()

</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>void Pipe::writer()
{
    pipe_lock.Lock();
    while (state != STATE_CLOSED) {
        ...
        Message *m = _get_next_outgoing();
        ...
        const ceph_msg_header&amp; header = m-&gt;get_header();
        const ceph_msg_footer&amp; footer = m-&gt;get_footer();
        bufferlist blist = m-&gt;get_payload();
        blist.append(m-&gt;get_middle());
        blist.append(m-&gt;get_data());
        pipe_lock.Unlock();

        write_message(header, footer, blist);
        ...
    }
}
</code></pre></div></div>
<p><br />
è½¬è½½è¯·æ³¨æ˜ï¼š<a href="https://rootw.github.io">å´æ–Œçš„åšå®¢</a> Â» <a href="https://rootw.github.io/2018/03/RBD-OSD-1">ã€Rados Block Deviceã€‘å…­ã€OSDåŸç†åˆ†æï¼SimpleMessengeræ¨¡å—</a></p>
:ET