I"<h3 id="1-rbdå—è®¾å¤‡åˆ›å»º">1. RBDå—è®¾å¤‡åˆ›å»º</h3>

<p>â€ƒâ€ƒå›é¡¾å¼€ç¯‡ä»‹ç»RBDå—è®¾å¤‡çš„ä½¿ç”¨æ–¹æ³•ï¼Œåˆ†ä¸ºåˆ›å»ºã€æ˜ å°„å’Œä½¿ç”¨ä¸‰æ­¥ã€‚åˆ›å»ºè¿‡ç¨‹ä¸»è¦æ˜¯ç”¨æˆ·æ€rbdå·¥å…·ä¸radosé›†ç¾¤é€šä¿¡å®Œæˆçš„ï¼Œä¸æ¶‰åŠå†…æ ¸RBDé©±åŠ¨ï¼›ä½†é—®é¢˜æ˜¯radosé›†ç¾¤ä¸­çš„OSDæä¾›çš„æ˜¯å¯¹è±¡æœåŠ¡(æˆ‘ä»¬å¯ä»¥æŠŠå¯¹è±¡ç®€å•ç†è§£æˆkey/valueå¯¹)ï¼Œå¦‚ä½•æ¥è¡¨è¾¾ä¸€ä¸ªRBDå—è®¾å¤‡ï¼Ÿ</p>

<p>â€ƒâ€ƒæˆ‘ä»¬é€šè¿‡rados lså‘½ä»¤æ¥æŸ¥çœ‹ä¸€ä¸‹wbpoolä¸­åˆ›å»ºäº†ä¸€ä¸ªåä¸ºwbçš„RBDè®¾å¤‡åéƒ½ç”Ÿæˆäº†å“ªäº›å¯¹è±¡ï¼š</p>

<blockquote>
  <p>[root@ceph-client]# <strong>rados ls --pool</strong> wbpool<br />
rbd_header.371e643c9869<br />
rbd_directory  <br />
rbd_object_map.371e643c9869<br />
rbd_id.wb<br />
rbd_info</p>
</blockquote>

<p>â€ƒâ€ƒè¿™äº›å¯¹è±¡é‡Œåˆ°åº•åŒ…å«äº†å“ªäº›ä¿¡æ¯å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ç”¨rados getå‘½ä»¤è·å–å¯¹è±¡å†…å®¹åˆ°æ–‡ä»¶ä¸­å¹¶æ‰“å¼€æ–‡ä»¶è¿›è¡ŒæŸ¥çœ‹ã€‚å…ˆçœ‹çœ‹rbd_id.wbå¯¹è±¡å†…å®¹ï¼š</p>

<blockquote>
  <p>[root@ceph-client]# <strong>rados get</strong> rbd_id.wb ./result.txt <strong>--pool</strong> wbpool; <strong>hexdump -Cv</strong> ./result.txt<br />
00000000  0c 00 00 00 33 37 31 65  36 34 33 63 39 38 36 39 |â€¦.371e643c9869|<br />
00000010</p>
</blockquote>

<p>â€ƒâ€ƒä»æ–‡ä»¶å†…å®¹çœ‹ï¼Œrbd_id.wbä¸­ä¿å­˜çš„ä¸»è¦æ˜¯ä¸ªidä¿¡æ¯ï¼Œä¸ºâ€371e643c9869â€(å‰å››ä¸ªå­—èŠ‚ä»£è¡¨ä»€ä¹ˆæ„æ€ï¼Ÿé€šè¿‡å°ç«¯æ³•è¡¨ç¤ºå¯¹è±¡å®é™…å†…å®¹çš„å­—èŠ‚é•¿åº¦ï¼Œä¾‹å¦‚è¿™é‡Œæ˜¯0x0000000Cï¼Œå³12ä¸ªå­—èŠ‚)ã€‚çŸ¥é“äº†wbå—è®¾å¤‡çš„idï¼Œæˆ‘ä»¬å†çœ‹æ¥çœ‹çœ‹rbd_head.371e643c9869å¯¹è±¡ä¸­çš„å†…å®¹ï¼š</p>

<blockquote>
  <p>[root@ceph-client]# rados get rbd_header.371e643c9869 ./result.txt â€“pool wbpool; hexdump -Cv ./result.txt</p>

</blockquote>

<p>â€ƒâ€ƒrbd_header.371e643c9869å¯¹è±¡å†…å®¹ä¸ºç©ºï¼Œæ€ä¹ˆå›äº‹å‘¢ï¼Ÿæˆ‘ä»¬å†æ¥çœ‹çœ‹è¯¥å¯¹è±¡ç›¸å…³çš„key/value omapå€¼(å¯ä»¥ç”¨æ¥æè¿°å¯¹è±¡çš„å…ƒæ•°æ®ä¿¡æ¯)ï¼š</p>

<blockquote>
  <p>[root@ceph-client]# <strong>rados listomapvals</strong> rbd_header.371e643c9869 <strong>--pool</strong> wbpool<br />
create_timestamp<br />
value (8 bytes) :<br />
00000000  63 38 26 5a 84 c1 71 08 |c8&amp;Z..q.|<br />
00000008</p>

  <p>features<br />
value (8 bytes) :<br />
00000000  01 00 00 00 00 00 00 00 |â€¦â€¦..|<br />
00000008</p>

  <p>flags<br />
value (8 bytes) :<br />
00000000  00 00 00 00 00 00 00 00 |â€¦â€¦..|<br />
00000008</p>

  <p>object_prefix<br />
value (25 bytes) :<br />
00000000  15 00 00 00 72 62 64 5f  64 61 74 61 2e 33 37 31 |â€¦.rbd_data.371|<br />
00000010  65 36 34 33 63 39 38 36  39 |e643c9869|<br />
00000019</p>

  <p>order 
value (1 bytes) :<br />
00000000  16                                                |.|<br />
00000001</p>

  <p>size<br />
value (8 bytes) :<br />
00000000  00 00 00 40 00 00 00 00 |â€¦@â€¦.|<br />
00000008</p>

  <p>snap_seq<br />
value (8 bytes) :<br />
00000000  00 00 00 00 00 00 00 00 |â€¦â€¦..|<br />
00000008</p>
</blockquote>

<p>â€ƒâ€ƒè¿™æ ·æˆ‘ä»¬çœ‹åˆ°rbd_header.371e643c9869å¯¹è±¡çš„omapä¸­ä¿å­˜ä¸RBDç›¸å…³çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œå¦‚RBDæ•°æ®å­˜æ”¾å¯¹è±¡å‰ç¼€ä¸ºâ€rbd_data.371e643c9869â€ï¼›orderä¸º0x16ï¼Œè¡¨ç¤ºä»¥4Må•ä½æ¥åˆ’åˆ†RBDå—è®¾å¤‡ï¼Œæ¯4Må¯¹åº”ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡åä¸ºâ€rbd_data.371e643c9869.åç§»â€ï¼›sizeä¸º0x40000000ï¼Œå³1Gã€‚</p>

<p>â€ƒâ€ƒæœ€åæˆ‘ä»¬æ¥çœ‹çœ‹å¦å¤–ä¸¤ä¸ªä¸å…·ä½“rbdè®¾å¤‡æ— å…³çš„å¯¹è±¡rbd_infoå’Œrbd_directoryï¼š</p>

<blockquote>
  <p>[root@ceph-client]# <strong>rados get</strong> rbd_info ./result.txt <strong>--pool</strong> wbpool; <strong>hexdump -Cv</strong> ./result.txt<br />
00000000  6f 76 65 72 77 72 69 74  65 20 76 61 6c 69 64 61 |overwrite valida|<br />
00000010  74 65 64                                          |ted|<br />
00000013</p>

  <p>[root@ceph-client]# <strong>rados get</strong> rbd_directory ./result.txt <strong>--pool</strong> wbpool; <strong>hexdump -Cv</strong> ./result.txt<br />
[root@ceph-client]# <strong>rados listomapvals</strong> rbd_directory <strong>--pool</strong> wbpool<br />
id_371e643c9869<br />
value (6 bytes) :<br />
00000000  02 00 00 00 77 62                                 |â€¦.wb|<br />
00000006</p>

  <p>name_wb<br />
value (16 bytes) :<br />
00000000  0c 00 00 00 33 37 31 65  36 34 33 63 39 38 36 39 |â€¦.371e643c9869|<br />
00000010</p>
</blockquote>

<p>â€ƒâ€ƒä»ç»“æœæˆ‘ä»¬çœ‹å‡ºrbd_infoä¸­åªæ˜¯ä¿å­˜äº†ä¸€ä¸ªæç¤ºå­—ç¬¦ä¸²â€overwirte validatedâ€ã€‚rbd_directoryå¯¹è±¡çš„mapä¸­ä¿å­˜äº†æ‰€æœ‰RBDå—è®¾å¤‡çš„åå­—å’Œidçš„å¯¹åº”å…³ç³»ï¼Œå¯å®ç°åŒå‘æŸ¥æ‰¾ã€‚</p>

<p>â€ƒâ€ƒç»¼ä¸Šæ‰€è¿°ï¼Œcephä¸­ä¹Ÿæ˜¯åˆ©ç”¨äº†å¯¹è±¡å­˜å‚¨çš„æ–¹å¼æ¥ä¿å­˜RBDä¿¡æ¯ï¼šâ€rbd_id.å—è®¾å¤‡åâ€å¯¹è±¡ä¸­ä¿å­˜å¯¹åº”å—è®¾å¤‡çš„idï¼›â€rbd_header.å—è®¾å¤‡idâ€çš„omapä¸­ä¿å­˜äº†å—è®¾å¤‡çš„å„ç§å…ƒæ•°æ®ä¿¡æ¯(è¿™é‡Œæ²¡æœ‰ç›´æ¥ä¿å­˜çš„å¯¹è±¡å†…å®¹ä¸­ï¼Œé€šè¿‡omapæ›´æ˜“è§£æ)ï¼›â€rbd_data.å—è®¾å¤‡id.åç§»â€å¯¹è±¡ç”¨æ¥ä¿å­˜å—è®¾å¤‡å¯¹åº”åç§»å¤„çš„æ•°æ®ï¼›rbd_directoryç”¨æ¥ä¿å­˜poolä¸­æ‰€æœ‰çš„RBDè®¾å¤‡çš„åç§°å’Œidã€‚</p>

<p><br />
è½¬è½½è¯·æ³¨æ˜ï¼š<a href="https://rootw.github.io">å´æ–Œçš„åšå®¢</a> Â» <a href="https://rootw.github.io/2018/01/RBD-client-1/">ã€Rados Block Deviceã€‘äºŒã€Clientå†…æ ¸RBDé©±åŠ¨åˆ†æï¼è®¾å¤‡åˆ›å»ºæµç¨‹</a></p>
:ET