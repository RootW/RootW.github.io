I"Ø<p>â€ƒâ€ƒé™¤äº†virtio-mmioè®¾å¤‡ï¼Œfirecrackerè¿˜å®ç°äº†ä¸²å£ã€é”®ç›˜ç­‰legacyè®¾å¤‡ï¼Œè¿™äº›è®¾å¤‡å¯ä»¥ç›´æ¥ç”±è™šæ‹Ÿæœºå†…æ ¸è‡ªå¸¦é©±åŠ¨ç¨‹åºé©±åŠ¨ï¼Œå¹¶ä¸ºè™šæ‹Ÿæœºæä¾›åŸºæœ¬çš„è¾“å…¥è¾“å‡ºåŠŸèƒ½ã€‚X86æ¶æ„ä¸‹ï¼Œlegacyè®¾å¤‡ä¸»è¦é€šè¿‡IOç«¯å£è¿›è¡Œæ§åˆ¶å’Œæ“ä½œï¼Œå› æ­¤firecrackeré‡‡ç”¨IOæ€»çº¿æ¥ç»„ç»‡å’Œç®¡ç†æ‰€æœ‰çš„legacyè®¾å¤‡ã€‚</p>

<h3 id="è¿è¡Œæ—¶åŸç†">è¿è¡Œæ—¶åŸç†</h3>

<p>â€ƒâ€ƒå’Œmmioæ€»çº¿ç±»ä¼¼ï¼Œlegacyè®¾å¤‡ä¹Ÿä»¥BTreeå½¢å¼ç»„ç»‡äºdevices::Busä¸‹ï¼Œå¹¶ä¸”æ¯ä¸ªè®¾å¤‡éƒ½éœ€è¦å®ç°BusDevice traitï¼š</p>

<pre><code class="language-nohighlight">firecracker/devices/src/legacy/i8042.rs:

pub struct I8042Device {                               // i8042ä¸ºé”®ç›˜å¯¹è±¡
    â€¦
}

impl BusDevice for I8042Device {                       // å®ç°ç«¯å£è¯»å†™æ“ä½œ                                  
    fn read(&amp;mut self, offset: u64, data: &amp;mut [u8]) {
        â€¦
    }

    fn write(&amp;mut self, offset: u64, data: &amp;[u8]) {
        â€¦
    }
}
</code></pre>
<pre><code class="language-nohighlight">firecracker/devices/src/legacy/serial.rs:

pub struct Serial {                                    // ä¸²å£å¯¹è±¡
    â€¦
}

impl BusDevice for Serial {                            // å®ç°ç«¯å£è¯»å†™æ“ä½œ                                                  
    fn read(&amp;mut self, offset: u64, data: &amp;mut [u8]) {
        â€¦
    }

    fn write(&amp;mut self, offset: u64, data: &amp;[u8]) {
        â€¦
    }
}
</code></pre>

<p>â€ƒâ€ƒå›é¡¾å‰æ–‡åˆ†æCPUåŸç†æ—¶ä»‹ç»çš„å†…å®¹ï¼Œå½“è™šæ‹ŸCPUæ‰§è¡Œç«¯å£è¯»å†™æŒ‡ä»¤æ—¶(in/outæŒ‡ä»¤)ï¼Œä¼šé€€å‡ºåˆ°ç”¨æˆ·æ€VMMç¨‹åºè¿›è¡Œå¤„ç†ï¼Œè¿™é‡Œå°±æ˜¯firecrackerçš„vCPUçº¿ç¨‹ä¸Šä¸‹æ–‡ã€‚æ­¤æ—¶vCPUçº¿ç¨‹å°±ä¼šæ ¹æ®ç«¯å£åœ°å€åœ¨IOæ€»çº¿ä¸Šæœç´¢å¯¹åº”çš„legacyè®¾å¤‡ï¼Œå¹¶è°ƒç”¨è®¾å¤‡å¯¹ç«¯å£çš„è¯»å†™æ“ä½œæ¥å£ã€‚å…·ä½“è®¾å¤‡çš„æ“ä½œæ–¹æ³•å¤§å®¶å¯ä»¥å¯¹ç…§ç›¸å…³è§„èŒƒæ–‡æ¡£å±•å¼€ä»£ç åˆ†æã€‚</p>

<h3 id="åˆå§‹åŒ–">åˆå§‹åŒ–</h3>

<p>â€ƒâ€ƒfirecrackerä½¿ç”¨LegacyDeviceManageræ¥ç®¡ç†æ‰€æœ‰legacyè®¾å¤‡ï¼Œå¹¶é€šè¿‡å…¶ä¸‹register_devicesæ–¹æ³•æ¥åˆå§‹åŒ–legacyè®¾å¤‡ï¼š</p>

<pre><code class="language-nohighlight">firecracker/vmm/src/lib.rs:
    fn attach_legacy_devices(&amp;mut self) -&gt; std::result::Result&lt;(), StartMicrovmError&gt; {            // legacyè®¾å¤‡æ•´ä½“åˆå§‹åŒ–å‡½æ•°
        self.legacy_device_manager                                                                 //  é€šè¿‡LegacyDeviceManagerçš„register_devicesæ¥æ³¨å†Œlegacyè®¾å¤‡                                           
            .register_devices()                                                      
            .map_err(StartMicrovmError::LegacyIOBus)?;                              

        self.vm                                                                      
            .get_fd()                                                               
            .register_irqfd(self.legacy_device_manager.com_evt_1_3.as_raw_fd(), 4)                 // ä¸ºä¸²å£å¯¹åº”çš„eventfdç”³è¯·irqfd
            .map_err(|e| {                                                          
                StartMicrovmError::LegacyIOBus(device_manager::legacy::Error::EventFd(e))
            })?;                                                                    
        â€¦                                                                     
        self.vm                                                                     
            .get_fd()                                                               
            .register_irqfd(self.legacy_device_manager.kbd_evt.as_raw_fd(), 1)                     // ä¸ºé”®ç›˜å¯¹åº”çš„eventfdç”³è¯·irqfd
            .map_err(|e| StartMicrovmError::LegacyIOBus(device_manager::legacy::Error::EventFd(e)))
}


firecracker/vmm/src/device_manager/legacy.rs:

pub struct LegacyDeviceManager {                           // æ‰€æœ‰legacyè®¾å¤‡ç®¡ç†å™¨                                             
    pub io_bus: devices::Bus,                              // IOæ€»çº¿ï¼Œä»¥BTreeç»„ç»‡legacyè®¾å¤‡
    pub stdio_serial: Arc&lt;Mutex&lt;devices::legacy::Serial&gt;&gt;, // ä¸²å£å¯¹è±¡ 
    pub i8042: Arc&lt;Mutex&lt;devices::legacy::I8042Device&gt;&gt;,   // é”®ç›˜å¯¹è±¡                     

    pub com_evt_1_3: EventFd,                              // ä¸²å£1ã€3å¯¹åº”çš„eventfd                                                 
    pub com_evt_2_4: EventFd,                              // ä¸²å£2ã€4å¯¹åº”çš„eventfd
    pub kbd_evt: EventFd,                                  // é”®ç›˜å¯¹åº”çš„eventfd
    pub stdin_handle: io::Stdin,                           // æ ‡å‡†è¾“å…¥
}

impl LegacyDeviceManager {
    â€¦                                                            
    pub fn register_devices(&amp;mut self) -&gt; Result&lt;()&gt; {                          
        self.io_bus                                        // å°†ä¸²å£å¯¹è±¡æ·»åŠ åˆ°ç«¯å£åœ°å€0x3F8~0x3FFï¼Œ
            .insert(self.stdio_serial.clone(), 0x3f8, 0x8) // ç”±è§„èŒƒå®šä¹‰               
            .map_err(Error::BusError)?;                                         
        â€¦                                                              
        self.io_bus                                        // å°†é”®ç›˜å¯¹è±¡æ·»åŠ åˆ°ç«¯å£åœ°å€0x60~0x64 ï¼Œ                                                     
            .insert(self.i8042.clone(), 0x060, 0x5)        // ç”±è§„èŒƒå®šä¹‰            
            .map_err(Error::BusError)?;    
        Ok(())                                                                  
    }                                                                           
}
</code></pre>
<p><br />
è½¬è½½è¯·æ³¨æ˜ï¼š<a href="https://rootw.github.io">å´æ–Œçš„åšå®¢</a> Â» <a href="https://rootw.github.io/2019/09/firecracker-legacy/">ã€firecrackerã€‘legacyè®¾å¤‡</a></p>
:ET