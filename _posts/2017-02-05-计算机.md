---
layout: post
title: 计算机
date: 2017-02-05 
tags: 自顶向下分析计算机系统(基于Linux内核)
---

&emsp;&emsp;各种外部系统是人们身体的延伸，而**自顶向下**思维方法是我们理解系统最为有效的手段。要想成为一名好的程序员，学会自顶向下理解计算机系统将是必备基本功。从本篇博文开始，我们就沿着"what->why->how"的脉络来剖析计算机系统。

### 什么是计算机？为什么需要它？

&emsp;&emsp;我们每个人都有个人电脑(PC, Personal Computer)，可以想象一下，你的电脑正在你的面前。首先，我们都知道通常它是由显示器、鼠标、键盘和主机组成的。当你按下电源键打开电脑后，如果你想在电脑中保存一些内容，你会把光标移动到word程序图标之上，并通过双击鼠标左键打开这个程序；之后你可以在程序的窗口中输入你想保存的东西，比如通过键盘输入"hello,world!"；接着通过菜单栏中的保存按钮你可以确认期望保存的文件位置，比如/root/hello.txt；如果一切顺利，那么当你再次打开这个文件的时候，你会看到里面的内容还是"hello,world!"。又或者你想借助电脑进行一些数值运算，这时你会打开计算器程序，在里面输入你想计算的算式，比如"1+1"；当前点击等号按钮时，你就会得到你想要的计算结果，比如这里就是2。再或者你想给远方的朋友发个问候，你只需要打开即时通信程序，选择你的好友之后，输入你想说的话，点击发送之后你的好友就会在他的电脑上看到你发送的消息。如果你想在工作的时候听听音乐，也未尝不可，你只需要打开音乐播放器后选择你想听的歌曲，当你回到工作程序时，你的电脑会保持工作程序和音乐播放器同时运行，两者不会有影响。当然，如果你和我一样，也是一个程序员的话，也可以完全不必受限于电脑中已有的程序：打开代码编辑器，输入你想要的代码，编译，运行，想要什么功能就有什么功能(简直就是上帝:-))。

&emsp;&emsp;上面这些是大家所熟悉的使用场景，它们涵盖了机算机的核心概念：从**物理视角**上看，计算机包含输入输出设备和主机；首先使用者通过输入设备产生物理变化（机械或光，包含命令和信息），接着主机基于内部状态和输入设备的物理变化，发生内部状态的改变，并且这种内部状态的改变与输入设备的物理变化（命令）存在确定性的对应关系，最后主机通过输出设备将内部状态传递给使用者；从**功能视角**上看，计算机在命令的控制下，实现了以存储、计算、网络通信为基础的各种功能。另外，这些功能不但可以多任务并行化提升效率，而且可以通过编程(顺序、分支、循环、函数)的方式组合扩展出更多丰富的功能。

&emsp;&emsp;计算机提供的存储、计算和网络功能就像七巧板一样，可以拼装出各色各样鲜活漂亮的图案，所以理论上，它可以**满足人们所有的信息化需求(信息获取、状态改变)，取代大量的脑力劳动**，成为人类最忠实的助手。

### 如何实现计算机？

&emsp;&emsp;在自项向下的分析方法中，每当我们深入一个系统(或一个部件)内部时，就会看到一些子系统(或子部件)，首先我们要分析它们的结构和工作过程(回答子系统是什么)，其次我们要明确它们相互之间是如何配合以完成系统整体功能的(回答为什么需要这个子系统)，这就是自顶向下方法的精髓所在。

&emsp;&emsp;对于计算机系统来说，这里我们以intel x86架构下经典的i440fx系统为例来展示其内部组成：

<div align="center">
    <img src="/images/posts/i440fx/i440fx2.jpg" height="530" width="720">  
</div> 

&emsp;&emsp;图中从上往下看，整个i440fx系统中的设备包含：CPU（图中画了两个逻辑核示意，每个CPU内部包含Memory Management Unit）、北桥（PMC, PCI and Memory Controller）、显卡（AGP）、内存、南桥（PIIX3, PCI IDE ISA Accelerator）、PCI插槽和设备（如网卡、存储Raid卡控制器等）。另外，i440fx属多核体系，其中断部分包含LAPIC（Local Advanced Programmable Interrupt Controller，每个逻辑CPU包含一个）和IOAPIC（Input/Output Advanced Programmable Interrupt Controller，集成在PIIX3南桥中）两部分。除了设备，系统中还包含连接设备的各类总线：FSB（Front System Bus，连接CPU和北桥）、PCI总线（Peripheral Component Interconnect，连接南北桥和所有的PCI设备）、IDE总线（“Integrated Drive Electronics，连接南桥中IDE控制器和传统IDE硬盘）、USB（Universal Serial Bus，连接USB控制器和USB设备）、ISA总线（Industry Standard Architecture，连接南桥ISA控制器和传统ISA设备，如鼠标和键盘；传统ISA总线采用两片级联的8259A芯片作为中断控制器直连单核CPU的INTR引脚，在i440fx中为了兼容老的单核操作系统仍保留了该功能，但是现代多核操作系统已不使用8259A芯片，而采用IOAPIC进行中断通知）。

&emsp;&emsp;这里我们先介绍一下最核心的几个部件的功能(CPU、内存、存储设备和网络设备)，并简要了解各部件之间的协作流程，后续我们将针对各部件进行深入分析。

&emsp;&emsp;我们通过命令控制计算机，命令在计算机内部是以程序的方式得以执行(运行的程序也称为进程)。每个进程包含一些函数和数据，这些函数通过操作数据实现各种功能。这样便引出了计算机内部两个重要的部件：**CPU**和**内存**：内存负责存储函数(代码段)和数据(数据段、堆栈段)；CPU则负责从内存中取出函数（指令），然后在指令的控制下完成数据读取、运算或数据写回等动作。

&emsp;&emsp;介绍完了CPU和内存，我们再来看看外部设备：**存储设备**为CPU提供数据存取服务，如磁盘；**网络设备**为CPU提供数据收发服务，如网卡。虽然存储设备和网络设备内部可能包含复杂的系统结构，但是它们和CPU之间通信总是通过总线和中断进行的。CPU将外设的访问接口视为内存(MMIO)或端口(PIO)，通过读写内存或端口完成命令和数据传递；外设则通过中断方式通知CPU特定事件的发生。

&emsp;&emsp;我们以使用word程序进行文档保存的场景来看看是计算机内部部件是如何协同工作的：移动鼠标并双击图标时，鼠标会将这此操作转换成事件并通过中断通知CPU；CPU进入中断上下文执行中断处理函数来捕获这些事件，之后交由SHELL程序(计算机开机后自动运行的服务程序，负责接收用户的输入、显示图形界面并运行相应的程序)进行解析；SHELL解析得知用户期望运行word程序，随即通过系统调用来创建一个新的进程(运行中的程序)；CPU在时钟的驱使下开始调度执行新创建的word进程，进程运行初期由于并未分配可用的内存会产生缺页异常；CPU在异常处理过程中为进程分配内存并进行地址映射，完成后便重新进行进程的执行；该进程正常运行时首先会通知SHELL程序需要在显示器上生成一个新窗口并注册事件处理函数；新窗口产生后，word进程便可以捕获用户的输入；用户完成输入以后，点按保存按钮进行保存时SHELL再次通知word进程发生了保存事件，word进程便会执行事件处理函数通过系统存储接口向存储设备发起存储请求，word进程自身则进入睡眠状态；存储设备存储完成后，通过中断通知CPU，CPU便会唤醒word进程再次进入可编辑状态(注：实际的word程序不会以同步化方式等待IO操作，这里为了方便说明问题作了一些简化)。

&emsp;&emsp;由此可见，即便一个简单的使用场景，也涉及到计算机内部诸多部件。此时我们对各个部件的基本功能有了一定了解，但理解的深入度仍是不够的，后续将基于x86_64架构上的linux_3.10内核分篇对计算(CPU和内存)、中断、时间、PCI、存储和网络子系统分别进行分析，自上而下、层层深入。愿自己能有更多的时间学习、总结和分享，enjoy hacking the system~

<br>
转载请注明：[吴斌的博客](https://rootw.github.io) » [计算机](https://rootw.github.io/2017/02/计算机/) 
